---
layout: post
title: æ“ä½œç³»ç»Ÿ_å¹¶å‘
---
<br>

# start
<br>

Don't Panicï¼
<br>

shellï¼šå°†è‡ªç„¶è¯­è¨€ç¿»è¯‘æˆæ“ä½œç³»ç»Ÿèƒ½ç†è§£çš„è¯­è¨€ã€‚
<br>

topicï¼š
<br>

whyï¼Ÿ whatï¼Ÿ howï¼Ÿ
<br>

å›¾çµæœºä¸å¯è®¡ç®—æ€§
<br>

1946.2.14 eniac è¯ç”Ÿ
<br>

ä¸€ä¸ªå†…å­˜å¯ä»¥æ”¾ä¸¤ä¸ªç¨‹åºäº†ï¼ 
<br>

+
<br>

åªæœ‰1ä¸ªcpu
<br>

=åˆ†æ—¶æ“ä½œç³»ç»Ÿ å¹¶å‘ï¼
<br>

è¿›ç¨‹+è™šæ‹Ÿå†…å­˜
<br>

![image-20241010213343250](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241010213343250.png)
<br>

[Read The Fucking Manual]
<br>

[Search The Fucking Web]
<br>

æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„
<br>

æ²¡æœ‰æµ‹è¯•çš„ä»£ç æ°¸è¿œæ˜¯é”™çš„
<br>

Get Your Hands Dirty
<br>

# ä»€ä¹ˆæ˜¯ç¨‹åº
<br>

çŠ¶æ€æœºï¼š
<br>

æ•°å­—é€»è¾‘ç”µè·¯
<br>

çŠ¶æ€ï¼šå¯„å­˜å™¨
<br>

åˆå§‹çŠ¶æ€ï¼š
<br>

è¿ç§»ï¼šç»„åˆé€»è¾‘ç”µè·¯
<br>

ç†è§£æ•°å­—é€»è¾‘ç”µè·¯å¤„çš„cä»£ç ï¼Œgcc å®å±•å¼€ done
<br>

ä¸ƒæ®µç®¡ done
<br>

```c
#include <stdio.h>
#include <unistd.h>
<br>

#define REGS_FOREACH(_)  _(X) _(Y)
#define OUTS_FOREACH(_)  _(A) _(B) _(C) _(D) _(E) _(F) _(G)
#define RUN_LOGIC        X1 = !X && Y; \
                         Y1 = !X && !Y; \
                         A  = (!X && !Y) || (X && !Y); \
                         B  = 1; \
                         C  = (!X && !Y) || (!X && Y); \
                         D  = (!X && !Y) || (X && !Y); \
                         E  = (!X && !Y) || (X && !Y); \
                         F  = (!X && !Y); \
                         G  = (X && !Y); 
<br>

#define DEFINE(X)   static int X, X##1;
#define UPDATE(X)   X = X##1;
#define PRINT(X)    printf(#X " = %d; ", X);
<br>

int main() {
  REGS_FOREACH(DEFINE);
  OUTS_FOREACH(DEFINE);
  while (1) { // clock
    RUN_LOGIC;
    OUTS_FOREACH(PRINT);
    REGS_FOREACH(UPDATE);
    putchar('\n');
    fflush(stdout);
    sleep(1);
  }
}
```
<br>

```python
import fileinput
 
TEMPLATE = '''
\033[2J\033[1;1f
     AAAAAAAAA
    FF       BB
    FF       BB
    FF       BB
    FF       BB
    GGGGGGGGGG
   EE       CC
   EE       CC
   EE       CC
   EE       CC
    DDDDDDDDD
''' 
BLOCK = {
    0: '\033[37mâ–‘\033[0m', # STFW: ANSI Escape Code
    1: '\033[31mâ–ˆ\033[0m',
}
VARS = 'ABCDEFG'
<br>

for v in VARS:
    globals()[v] = 0
stdin = fileinput.input()
<br>

while True:
    exec(stdin.readline())
    pic = TEMPLATE
    for v in VARS:
        pic = pic.replace(v, BLOCK[globals()[v]]) # 'A' -> BLOCK[A], ...
    print(pic)
<br>

```
<br>

- Make each program do one thing well
- Expect the output of every program to become the input to another
<br>

å®‰è£…mançš„å‹å¥½ç‰ˆæœ¬. Done 
<br>

wget è¯ä¹¦éªŒè¯å¤±è´¥ï¼Œéœ€è¦å¤„ç† done ã€bashrcè®¾ç½®åˆ«å
<br>

å›¾çµæœºæ˜¯çŠ¶æ€æœº
<br>

æ•°å­—ç³»ç»Ÿæ˜¯çŠ¶æ€æœº
<br>

æ‰€æœ‰çš„ç¨‹åºè¿è¡Œåœ¨æ•°å­—ç³»ç»Ÿä¸Šï¼Œç¨‹åº=çŠ¶æ€æœº
<br>

cè¯­è¨€ï¼š
<br>

å †æ ˆ=çŠ¶æ€
<br>

mainç¬¬ä¸€æ¡è¯­å¥=åˆå§‹çŠ¶æ€
<br>

æ‰§è¡Œè¯­å¥=çŠ¶æ€è¿ç§»
<br>

ä¾‹å­ï¼šgdbï¼šæ¯æ¬¡æ‰§è¡Œéƒ½å¯ä»¥info frame
<br>

cç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ï¼š
<br>

- çŠ¶æ€ = stack frame çš„åˆ—è¡¨ (æ¯ä¸ª frame æœ‰ PC) + å…¨å±€å˜é‡
<br>

- åˆå§‹çŠ¶æ€ = main(argc, argv), å…¨å±€å˜é‡åˆå§‹åŒ–
<br>

- è¿ç§» = æ‰§è¡Œ top stack frame PC çš„è¯­å¥; PC++
  - å‡½æ•°è°ƒç”¨ = push frame (frame.PC = å…¥å£)
  - å‡½æ•°è¿”å› = pop frame
<br>

  
<br>

æ±‰è¯ºå¡”çš„éé€’å½’ç‰ˆæœ¬ï¼šæ±‡ç¼–è¯­è¨€ã€‚æ±‡ç¼–å±‚é¢ï¼Œæ²¡æœ‰é€’å½’ã€‚
  
  **todo**ï¼šç†è§£æ±‰è¯ºå¡”çš„é€’å½’ä¸éé€’å½’ç‰ˆæœ¬ åŒæ—¶ å†æ¥ä¸ªcs61a è¿›ä¸€æ­¥ç†è§£ a>b ;b>aå½¢å¼çš„é€’å½’ï¼Œå†è¿›ä¸€æ­¥ç†è§£æ±‰è¯ºå¡”çš„éé€’å½’ç‰ˆæœ¬ã€‚
  
   
  
  gdbå¯ä»¥åˆ‡æ¢åˆ°æºä»£ç è§†è§’ï¼Ÿ Layout watchpoint 
  
  
  
  
  
  ç¨‹åºæ˜¯çŠ¶æ€æœºï¼š
  
  åœ¨è¿™ä¸ªçŠ¶æ€æœºä¸­ï¼Œå‡½æ•°è°ƒç”¨æ˜¯ä»€ä¹ˆï¼Ÿå‡½æ•°è¿”å›æ˜¯ä»€ä¹ˆï¼Ÿ
  
  éé€’å½’æ±‰è¯ºå¡”ï¼šéå†stackï¼Œä¸åœçš„å‹frameä¸æ’é™¤frameï¼Œ
  
  å˜é‡+æ ˆå¸§ && è¯­å¥
  
  
  
  
  
  
  äºŒè¿›åˆ¶ä¸‹ï¼ŒçŠ¶æ€æœºæ¨¡å‹ï¼š
  
  pc + å¯„å­˜å™¨ :è¿™ä¸ªæ¨¡å‹ä¸‹ï¼Œç¦»å¼€åŸæ¥çš„é€»è¾‘æµ éœ€è¦ å¼‚å¸¸
  
  çº¯ç²¹çš„è®¡ç®—ï¼šå†…å­˜/å¯„å­˜å™¨ å–å€¼/è®¡ç®—/æ”¾å›å»
  
  æ‰§è¡Œæµï¼š cpuä¸€ä½†å¯åŠ¨ï¼Œå°±ä¼šä¸åœçš„è¿è¡Œï¼Œå¦‚ä½•ä»æ‰§è¡Œæµä¸­äº§ç”Ÿåˆ†æ”¯--syscallï¼ˆå®ç°ä¸æ“ä½œç³»ç»Ÿçš„äº¤äº’ï¼‰ï¼šæŠŠçŠ¶æ€äº¤ç»™æ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»ŸçŸ¥é“ä½ è¦æ‰“å°ä»€ä¹ˆå°±ç»™ä½ æ‰“å°ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ä¿®æ”¹ä½ çš„çŠ¶æ€
  
  ç¨‹åº= è®¡ç®—+syscall
  
  Todo ç†è§£ minimal.Sã€‚ syscall æ‰‹å†Œ
  
  ç¨‹åºï¼š
  
  å¯„å­˜å™¨ã€å†…å­˜ + æŒ‡ä»¤ï¼šè®¡ç®—+syscall
  
  ç¨‹åºï¼Œè®¡ç®—å‡ºå›¾ç‰‡ï¼Œæ”¾åˆ°å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿå»å±•ç¤ºå›¾ç‰‡
  
  å¯„å­˜å™¨+å†…å­˜ && æŒ‡ä»¤
  
  ä¸¤ç§è§†è§’çš„åˆ‡æ¢ä¸å…³è”ï¼ˆç¼–è¯‘ï¼‰
  
  ç¼–è¯‘æ­£ç¡®æ€§ï¼š
  
  <img src="https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241011231552173.png" alt="image-20241011231552173" style="zoom:40%;" />
  
  è¿™é‡Œçš„ç¼–è¯‘æ­£ç¡®æ€§ ç±»æ¯” å¹¶å‘çš„æ­£ç¡®æ€§
  
  syscall  æ”¶ç¼–äº†æ‰€æœ‰çš„apiï¼Œæ“ä½œç³»ç»Ÿ= syscall + syscall å®šä¹‰çš„api
  
  need é‡å¤æ“ä½œä¸€éï¼Œç¬¬äºŒèŠ‚è¯¾
  
  `main()` ä¹‹å‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ
  
  strace
  
  todoï¼šæ€äººé¢è¯•é¢˜
  
  çŠ¶æ€æœºæ˜¯ä¸€ä¸ªä¸¥è°¨çš„æ•°å­¦å¯¹è±¡ã€‚è®¡ç®—æœºç³»ç»Ÿä¸å­˜åœ¨ç„å­¦ï¼›ä¸€åˆ‡éƒ½å»ºç«‹åœ¨ç¡®å®šçš„æœºåˆ¶ä¸Š
  
  <img src="https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241015223646858.png" alt="image-20241015223646858" style="zoom:40%;" />
  
  <img src="https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241015223807543.png" alt="image-20241015223807543" style="zoom:40%;" />
  
<br>

# ç¬¬ä¸€å‘¨é˜…è¯»ææ–™
<br>

è™šæ‹ŸåŒ–ï¼ˆvirtualizationï¼‰ã€å¹¶å‘ï¼ˆconcurrencyï¼‰ã€æŒä¹…æ€§ï¼ˆpersistenceï¼‰
<br>

crux of problem
<br>

æ“ä½œç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ
<br>

jyyï¼šç¡¬ä»¶è§†è§’ã€ç¨‹åºè§†è§’ã€æ•°å­¦è§†è§’ï¼Ÿ
<br>

ostepï¼šè™šæ‹ŸåŒ–ï¼Œå°†ç‰©ç†èµ„æºè½¬åŒ–ä¸ºè™šæ‹Ÿå½¢å¼ï¼ˆè™šæ‹Ÿæœºï¼‰ã€‚æä¾›äº†apiï¼Œæä¾›äº†ä¸€ä¸ªæ ‡å‡†åº“ã€‚è™šæ‹ŸåŒ–å®ç°äº†èµ„æºå…±äº«ï¼Œèµ„æºç®¡ç†å™¨ã€‚
<br>

è™šæ‹ŸåŒ–cpuï¼Œå•ä¸ªç‰©ç†cpuï¼Œä¼¼ä¹å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªç¨‹åº
<br>

è™šæ‹ŸåŒ–å†…å­˜
<br>

å¹¶å‘
<br>

æŒä¹…åŒ–
<br>

æ“ä½œç³»ç»Ÿï¼Œå°†ç‰©ç†èµ„æºè™šæ‹ŸåŒ–ï¼Œå¤„ç†å¹¶å‘ï¼Œå¹¶æŒä¹…çš„å­˜å‚¨æ–‡ä»¶ã€‚
<br>

targetï¼š
<br>

1. å®ç°åŠŸèƒ½çš„åŸºç¡€ä¸Šï¼Œæä¾›é«˜æ€§èƒ½çš„åŒæ—¶æœ€å°åŒ–æ“ä½œç³»ç»Ÿçš„å¼€é”€ã€‚
2. protection & isolation
<br>

ä¸€äº›åº“-> è¶…è¶Šåº“ -> å¹¶å‘å¤šä¸ªç¨‹åº
<br>

# AbstractMachine
<br>

å›¾çµæœº å°±æ˜¯ çŠ¶æ€æœºï¼Ÿ ç¼–ç¨‹è¯­è¨€ï¼Ÿ
<br>

![image-20241121215405837](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241121215405837.png)
<br>

å›¾çµæœºçš„å¯è®¡ç®—æ€§ -> å¦‚ä½•åˆ¶é€ ï¼Ÿ
<br>

ENIACï¼šç”¨ç”µå­ç®¡å®ç°çŠ¶æ€æœºï¼Œç„¶åè¯»å–æ•°æ®ï¼ŒçŠ¶æ€æµè½¬ã€‚
<br>

von neumannï¼šç¨‹åºä¹Ÿæ˜¯å¯ä»¥å­˜å‚¨èµ·æ¥ï¼Œå¯ä»¥æŠŠçŠ¶æ€æœºçš„å½¢æ€å­˜å‚¨èµ·æ¥
<br>

ioå‡ºç°äº†
<br>

cpu ä¸èƒ½ç­‰ioï¼šä¸­æ–­
<br>

![image-20241121221854347](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241121221854347.png)
<br>

ä¸­æ–­å¤„ç†ç¨‹åºå°±æ˜¯æ“ä½œç³»ç»Ÿã€‚
<br>

åˆ†æ—¶å¤šçº¿ç¨‹
<br>

åˆ†æ—¶å¤šçº¿ç¨‹+è™šæ‹Ÿå†…å­˜ = è¿›ç¨‹
<br>

cè¯­è¨€è¿è¡Œç¯å¢ƒï¼Œæä¾›äº†5ç»„APIï¼š
<br>

- (TRM) `putch`/`halt` - æœ€åŸºç¡€çš„è®¡ç®—ã€æ˜¾ç¤ºå’Œåœæœº
- (IOE) `ioe_read/ioe_write` - I/O è®¾å¤‡ç®¡ç†
- (CTE) `ienabled`/`iset`/`yield`/`kcontext` - ä¸­æ–­å’Œå¼‚å¸¸
- (VME) `protect`/`unprotect`/`map`/`ucontext` - è™šå­˜ç®¡ç†
- (MPE) `cpu_count`/`cpu_current`/`atomic_xchg` - å¤šå¤„ç†å™¨
<br>

## linux æ–‡æœ¬åˆ°æ‰§è¡Œ
<br>

questionï¼šcç¨‹åºæ˜¯å¦‚ä½•è¿è¡Œåœ¨è£¸æœºä¸Šçš„ï¼Ÿå¦‚ä½•ä»æ–‡æœ¬æ–‡ä»¶åˆ°æœ€ç»ˆåœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œèµ·æ¥ï¼Ÿå¦‚ä¸‹æ¯ä¸€æ­¥çš„ç»†èŠ‚ï¼Ÿ
<br>

1.ç”ŸæˆELFæ–‡ä»¶
<br>

2.å°†elfäºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½åˆ°æŒ‡å®šä½ç½®
<br>

3.å¦‚ä½•å°†pcè·³è½¬åˆ°ä½ç½®ä¸å›ºå®šçš„mainå‡½æ•°ä¸­
<br>

ç¼–è¯‘ã€é“¾æ¥ã€åŠ è½½ã€è¿è¡Œ
<br>

```shell
$ gcc -c -O2 -o main.o main.c
$ gcc -c -O2 -o say.o say.c
<br>

$ gcc main.o say.o
# or
$ ld -dynamic-linker /lib64/ld-linux-x86-64.so.2 \
  /usr/lib/x86_64-linux-gnu/crt1.o \
  /usr/lib/x86_64-linux-gnu/crti.o \
  main.o say.o -lc \
  /usr/lib/x86_64-linux-gnu/crtn.o
```
<br>

æˆ‘ä»¬å¾—åˆ°äº†å¯æ‰§è¡Œæ–‡ä»¶ã€‚å› ä¸ºå®æ˜¯åœ¨é¢„å¤„é˜¶æ®µè¢«å¤„ç†äº†ï¼Œæ‰€ä»¥ç¼–è¯‘æ—¶åªä½¿ç”¨äº†putcharï¼Œæ²¡æœ‰æˆ‘ä»¬è‡ªå®šä¹‰çš„putchï¼Œæ•…ä¸ä¼šæŠ¥é”™putch æœªå®šä¹‰ã€‚
<br>

now ä¸‹ä¸€æ­¥ï¼šåŠ è½½
<br>

ç®€å•çš„å½’çº³ï¼š
<br>

1.shell - fork
<br>

2.exevc åŠ¨æ€é“¾æ¥ & å°†pcè½¬ç§»åˆ°_startåˆå§‹åŒ–è¿è¡Œç¯å¢ƒï¼Œæœ€åè·³è½¬åˆ°mainæ–¹æ³•
<br>

3.printç­‰æ“ä½œåˆ™æ˜¯ç³»ç»Ÿè°ƒç”¨ syscall int
<br>

```shell
gdb
<br>

starti
<br>

bt f #backtrace full æŸ¥çœ‹çº¿ç¨‹stack
<br>

info inferiors #è¾“å‡ºå½“å‰è¿›ç¨‹ä¿¡æ¯
<br>

!cat /proc/18137/maps  # æ‰“å°è¿›ç¨‹çš„å†…å­˜ä¿¡æ¯  todo æ¯ä¸€æ®µå†…å­˜ æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆa.outæœ‰å››æ®µï¼Ÿ
<br>

_start
main
```
<br>

æ‰§è¡Œåˆ°_stratæ—¶ï¼Œå¯ä»¥æŸ¥çœ‹mapsï¼Œå·²ç»åˆå§‹åŒ–äº†stack/heap/lib.c/a.out  : å®Œå…¨çœ‹ä¸å‡ºé‚£æ˜¯å“ªå„¿ ğŸ˜‚
<br>

```gdb
Breakpoint 1, 0x0000555555555080 in _start ()
(gdb) !cat /proc/18490/maps
555555554000-555555555000 r--p 00000000 fc:03 1570637                    /learn/os/os-workbench-2022/L0/ud_abs/a.out
555555555000-555555556000 r-xp 00001000 fc:03 1570637                    /learn/os/os-workbench-2022/L0/ud_abs/a.out
555555556000-555555557000 r--p 00002000 fc:03 1570637                    /learn/os/os-workbench-2022/L0/ud_abs/a.out
555555557000-555555558000 r--p 00002000 fc:03 1570637                    /learn/os/os-workbench-2022/L0/ud_abs/a.out
555555558000-555555559000 rw-p 00003000 fc:03 1570637                    /learn/os/os-workbench-2022/L0/ud_abs/a.out
7ffff7d87000-7ffff7d8a000 rw-p 00000000 00:00 0 
7ffff7d8a000-7ffff7db2000 r--p 00000000 fc:03 132514                     /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7db2000-7ffff7f47000 r-xp 00028000 fc:03 132514                     /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7f47000-7ffff7f9f000 r--p 001bd000 fc:03 132514                     /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7f9f000-7ffff7fa0000 ---p 00215000 fc:03 132514                     /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7fa0000-7ffff7fa4000 r--p 00215000 fc:03 132514                     /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7fa4000-7ffff7fa6000 rw-p 00219000 fc:03 132514                     /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7fa6000-7ffff7fb3000 rw-p 00000000 00:00 0 
7ffff7fbb000-7ffff7fbd000 rw-p 00000000 00:00 0 
7ffff7fbd000-7ffff7fc1000 r--p 00000000 00:00 0                          [vvar]
7ffff7fc1000-7ffff7fc3000 r-xp 00000000 00:00 0                          [vdso]
7ffff7fc3000-7ffff7fc5000 r--p 00000000 fc:03 131486                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7fc5000-7ffff7fef000 r-xp 00002000 fc:03 131486                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7fef000-7ffff7ffa000 r--p 0002c000 fc:03 131486                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7ffb000-7ffff7ffd000 r--p 00037000 fc:03 131486                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7ffd000-7ffff7fff000 rw-p 00039000 fc:03 131486                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffffffde000-7ffffffff000 rw-p 00000000 00:00 0                          [stack]
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]
```
<br>

_start å®Œæˆåˆå§‹åŒ–åä¼šè°ƒç”¨ main()ï¼Œcç¨‹åºçš„åˆå§‹åŒ–ç”± _start è´Ÿè´£
<br>

## bare-metal æ–‡æœ¬åˆ°æ‰§è¡Œ
<br>

ä¸æ˜¯å¤ªç†è§£ abstractmachine
<br>

å…ˆè¯•ç€é˜…è¯»ä¸‹makefile
<br>

os-workbench-2022/Makefile
<br>

```makefile
export TOKEN   := ???
<br>

# ----- DO NOT MODIFY -----
<br>

ifeq ($(NAME),)
$(error Should make in each lab's directory)
endif
<br>

SRCS   := $(shell find . -maxdepth 1 -name "*.c")
DEPS   := $(shell find . -maxdepth 1 -name "*.h") $(SRCS)
CFLAGS += -O1 -std=gnu11 -ggdb -Wall -Werror -Wno-unused-result -Wno-unused-value -Wno-unused-variable
<br>

.PHONY: all git test clean commit-and-make
<br>

.DEFAULT_GOAL := commit-and-make
commit-and-make: git all
<br>

$(NAME)-64: $(DEPS) # 64bit binary
        gcc -m64 $(CFLAGS) $(SRCS) -o $@ $(LDFLAGS)
<br>

$(NAME)-32: $(DEPS) # 32bit binary
        gcc -m32 $(CFLAGS) $(SRCS) -o $@ $(LDFLAGS)
<br>

$(NAME)-64.so: $(DEPS) # 64bit shared library
        gcc -fPIC -shared -m64 $(CFLAGS) $(SRCS) -o $@ $(LDFLAGS)
<br>

$(NAME)-32.so: $(DEPS) # 32bit shared library
        gcc -fPIC -shared -m32 $(CFLAGS) $(SRCS) -o $@ $(LDFLAGS)
<br>

clean:
        rm -f $(NAME)-64 $(NAME)-32 $(NAME)-64.so $(NAME)-32.so
```
<br>

os-workbench-2022/Makefile.lab
<br>

```makefile
export COURSE := OS2022
URL := 'http://jyywiki.cn/static/submit-os2022.sh'
<br>

submit:
        @cd $(dir $(abspath $(lastword $(MAKEFILE_LIST)))) && \
          curl -sSLf '$(URL)' && \
          curl -sSLf '$(URL)' | bash
<br>

git:
        @git add $(shell find . -name "*.c") $(shell find . -name "*.h") -A --ignore-errors
        @while (test -e .git/index.lock); do sleep 0.1; done
        @(uname -a && uptime) | git commit -F - -q --author='tracer-nju <tracer@nju.edu.cn>' --no-verify --allow-empty
        @sync
```
<br>

## Make file å¯¼è¯»
<br>

absçš„makefile éå¸¸é•¿ï¼Œä½†è¦è¿›è¡Œå®éªŒè¿˜å¿…é¡»å¾—èŠ±æ—¶é—´ã€‚
<br>

makefile å·¥å…·
<br>

```shell
make -nB | grep -v '^mkdir' | vim -
```
<br>

```vim
:%s/^/\r
:%s/ /\r /g 
%s/learn\/os\/os-workbench-2022\/LAB/pwd /g
:w newfile.txt
<br>

:set nu
```
<br>

-Iï¼Œ-D ç­‰ç¼–è¯‘é€‰é¡¹ï¼Œå¯ä»¥vscodeè¡¥å…¨ï¼Œå®ç°æ­£ç¡®çš„è·³è½¬ã€‚ï¼Ÿï¼Ÿï¼Ÿ how todoï¼Ÿ -- bear
<br>

# ç¬¬äºŒå‘¨é˜…è¯»ææ–™
<br>

Todo:æ±‡ç¼–ä¸­ï¼Œå¦‚ä½•ç¡®å®š æ˜¯ç«‹å³æ•°è¿˜æ˜¯åœ°å€ï¼Ÿ å¯„å­˜å™¨çš„å€¼è¿˜æ˜¯å¯„å­˜å™¨å€¼å¯¹åº”çš„åœ°å€å¤„çš„å€¼ï¼Ÿ
<br>

cooperating sequential process:https://www.cs.utexas.edu/~EWD/transcriptions/EWD01xx/EWD123.html
<br>

çº¿ç¨‹
<br>

å…±äº«æ•°æ®
<br>

ä¸å¯æ§è°ƒåº¦
<br>

åŸå­æ€§
<br>

ä¸´ç•ŒåŒºã€ç«æ€æ¡ä»¶ã€ä¸ç¡®å®šæ€§ã€äº’æ–¥æ‰§è¡Œ
<br>

todoï¼šhomework
<br>

create
<br>

join
<br>

é”ï¼š
<br>

lockã€unlockã€åˆå§‹åŒ–
<br>

æ¡ä»¶å˜é‡ï¼š
<br>

waitã€signal
<br>

# 0x3çº¿ç¨‹åº“ã€ç°ä»£å¤„ç†å™¨å’Œå®½æ¾å†…å­˜æ¨¡å‹
<br>

cè¯­è¨€ç¨‹åºçš„å½¢å¼è¯­ä¹‰ï¼Ÿ
<br>

ä¸ºä»€ä¹ˆæ“ä½œç³»ç»Ÿè¦ç ”ç©¶å¹¶å‘ï¼Ÿ å› ä¸ºæ“ä½œç³»ç»Ÿæ˜¯ç¬¬ä¸€ä¸ªå¹¶å‘ç¨‹åºï¼
<br>

å¹¶å‘ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ï¼š
<br>

é»‘æ¿ï¼šå…±äº«å˜é‡
<br>

æ¯ä¸ªå­¦ç”Ÿï¼šçº¿ç¨‹ç§æœ‰ï¼ˆstack frameï¼ˆpc + å±€éƒ¨å˜é‡ï¼‰ï¼‰
<br>

çŠ¶æ€ï¼šå…¨å±€+çº¿ç¨‹ç§æœ‰
<br>

çŠ¶æ€çš„è¿ç§»ï¼šçº¿ç¨‹
<br>

äººç±»ï¼šå•çº¿ç¨‹ï¼Œåºåˆ—åŒ–
<br>

æ•´ä¸ªä¸–ç•Œï¼šå¹¶å‘
<br>

ç¤ºä¾‹ï¼šthread.h 
<br>

```c
#include "thread.h"
<br>

void Ta() { while (1) { printf("a"); } }
void Tb() { while (1) { printf("b"); } }
<br>

int main() {
  create(Ta);
  create(Tb);
}
```
<br>

æ“ä½œç³»ç»Ÿè‡ªåŠ¨æŠŠçº¿ç¨‹æ”¾åœ¨ä¸åŒçš„cpuä¸Šï¼Œ200%,ä¸ºä½•å¤ç°ä¸å‡ºæ¥ï¼Œä¼šæœ‰åªæœ‰å¤§æ¦‚2%ã€‚
<br>

todoï¼šThread.h å…¥é—¨åçš„ã€‚ä¹ é¢˜ & ç»ƒä¹  è¿›ä¸€æ­¥é…ç½®ï¼Œè®¾ç½®æ›´å¤§çš„çº¿ç¨‹stackã€‚45åˆ†é’Ÿå·¦å³
<br>

Stack-probe.c  å¦‚ä½•ç¡®å®šæ¯ä¸€æ¬¡é€’å½’æ—¶å ç”¨çš„stackç©ºé—´ï¼Ÿä¸ºä»€ä¹ˆè¿›è¡Œäº†8192 * 1024æ¬¡ é€’å½’å°±å¯ä»¥å¾—å‡º çº¿ç¨‹çš„stackç©ºé—´æ˜¯8192kBï¼Ÿ å³ä¸€æ¬¡é€’å½’å ç”¨1Bçš„ç©ºé—´ï¼Ÿ
<br>

```c
#include "thread.h"
<br>

__thread char *base, *cur; // thread-local variables
__thread int id;
<br>

// objdump to see how thread-local variables are implemented
__attribute__((noinline)) void set_cur(void *ptr) { cur = ptr; }
__attribute__((noinline)) char *get_cur()         { return cur; }
<br>

void stackoverflow(int n) {
  set_cur(&n);
  if (n % 1024 == 0) {
    int sz = base - get_cur();
    printf("Stack size of T%d >= %d KB\n", id, sz / 1024);
  }
  stackoverflow(n + 1);
}
<br>

void Tprobe(int tid) {
  id = tid;
  base = (void *)&tid;
  stackoverflow(0);
}
<br>

int main() {
  setbuf(stdout, NULL);
  for (int i = 0; i < 4; i++) {
    create(Tprobe);
  }
}
```
<br>

mov  %rax,%fs:0xfffffffffffffff0
<br>

mov  %fs:0xfffffffffffffff0,%rax
<br>

**`%fs:0xfffffffffffffff0`**ï¼šè¿™éƒ¨åˆ†æŒ‡å®šäº†ç›®æ ‡åœ°å€ã€‚`%fs` æ˜¯ä¸€ä¸ªæ®µå¯„å­˜å™¨ï¼Œç”¨äºè®¿é—®ç‰¹å®šçš„å†…å­˜æ®µã€‚`0xfffffffffffffff0` æ˜¯ä¸€ä¸ªç›¸å¯¹ `%fs` åŸºåœ°å€çš„åç§»é‡ã€‚
<br>

çº¿ç¨‹å˜é‡è¢«å­˜å‚¨åœ¨äº†ç‰¹å®šçš„æ®µå†…ã€‚
<br>

- åˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ -- clone
- gdb è°ƒè¯•å¤šçº¿ç¨‹ï¼š
<br>

å¹¶å‘ï¼š**åŸå­æ€§ä¸§å¤±**
<br>

ä¼ ç»Ÿçš„çŠ¶æ€æœºæ¨¡å‹ï¼šç¨‹åºæ˜¯ä¸€æ¡å®Œæ•´çš„åºåˆ—ï¼Œç‹¬å çš„ä½¿ç”¨ï¼›
<br>

å•å¤„ç†å™¨å¤šçº¿ç¨‹ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢
<br>

å¤šå¤„ç†å™¨å¤šçº¿ç¨‹ï¼šæœ¬è´¨æ˜¯å¹¶è¡Œçš„
<br>

```c
#include "thread.h"
<br>

#define N 100000000
<br>

long sum = 0;
<br>

void Tsum() {
  for (int i = 0; i < N; i++) {
    asm volatile("add $1, %0":"+m"(sum));
    //sum++;
  }
}
<br>

int main() {
  create(Tsum);
  create(Tsum);
  join();
  printf("sum = %ld\n", sum);
}
```
<br>

ä¸Šé¢è¿™ä¸ªä¾‹å­åœ¨å•å¤„ç†å™¨ä¸­æ˜¯æ­£ç¡®çš„ï¼Œä½†å¤šå¤„ç†å™¨ä¸æ­£ç¡®ï¼Ÿ å¦‚ä½•å°†ç¨‹åºé™åˆ¶åˆ°å•ä¸ªå¤„ç†å™¨ä¸Šã€‚
<br>

todoï¼š![image-20241024213109288](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241024213109288.png)
<br>

```shell
man printf
```
<br>

![image-20241024213151053](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241024213151053.png)
<br>

å¹¶å‘ï¼š**é¡ºåºæ€§ä¸§å¤±**
<br>

sum o1 æˆ– o2 ç¨‹åº¦çš„ä¼˜åŒ–
<br>

While(!done) -> if(!done) while(1);
<br>

ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼Œå¯¼è‡´çš„é¡ºåºä¸§å¤± -> barrier
<br>

å…±äº«å†…å­˜ä½œä¸ºçº¿ç¨‹åŒæ­¥çš„å·¥å…·å°±å¤±æ•ˆäº†ã€‚
<br>

æœ€å¤§çš„éº»çƒ¦ï¼šå†…å­˜æ¨¡å‹
<br>

å¹¶å‘ï¼š**å¯è§æ€§**
<br>

todo ç†è§£https://jyywiki.cn/pages/OS/2022/demos/mem-ordering.c done
<br>

cè¯­è¨€å†…åµŒæ±‡ç¼–
<br>

å‡ºç°äº†çŠ¶æ€æœºä¸­æ°¸è¿œä¸åº”è¯¥å‡ºç°çš„ï¼š0 0 ğŸ˜±
<br>

è®¡ç®—æœºä½“ç³»ç»“æ„ï¼šé‡åŒ–ç ”ç©¶æ–¹æ³•ã€‚æœ‰è¯¦ç»†è®²è¿°ä¹±åºæ‰§è¡ŒCAAQA
<br>

å¤ä¹ ä¸‹csappä¸­ å¤„ç†å™¨ä½“ç³»ç»“æ„
<br>

![image-20241113221415255](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241113221415255.png)
<br>

å¼€å…³ï¼Œå¯¼è‡´å¿…é¡»ä»å†…å­˜è¯»å–ï¼Œcache missï¼Ÿ rightï¼Ÿï¼Œ print (y) å…ˆäº èµ‹å€¼x = 1 æ‰§è¡Œã€‚
<br>

è®¡ç®—æœºä½“ç³»å¯¼è‡´çš„é¡ºåºæ€§ä¸§å¤±ã€‚
<br>

è¿™é‡Œçš„é¡ºåºæ€§ä¸å¯è§æ€§çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
<br>

Todo å†…å­˜æ¨¡å‹çš„é˜…è¯»
<br>

å¥‡æ€ªï¼šmem-ordering.c ç¤ºä¾‹ç¨‹åºå¹¶æ²¡æœ‰è¡¨ç°å‡º 11/00 çš„æƒ…å†µï¼Œå‡ ä¹å…¨æ˜¯01ï¼Œåœ¨èµ‹å€¼ä¸æ‰“å°ä¹‹é—´åŠ äº†usleep(1)ï¼Œå‹‰å¼ºå‡ºç°äº†01/10.  ç‰¹åˆ«æ…¢ï¼Œä¹Ÿå¤ç°ä¸å‡ºæ¥è§†é¢‘ä¸­çš„11/00.
<br>

### è®¡ç®—æœºä½“ç³»ç»“æ„ï¼šé‡åŒ–ç ”ç©¶æ–¹æ³•
<br>

20241115:ä»Šå¤©å®šä¸ªå°ç›®æ ‡ï¼Œå¤§è‡´ç†è§£æŒ‡ä»¤çº§å¹¶è¡Œï¼ˆNo.3ï¼‰ã€‚
<br>

æŒ‡ä»¤çº§å¹¶è¡Œï¼š
<br>

1.ä»¥å‰ä¸»è¦é€šè¿‡æµæ°´çº¿
<br>

2.å¤šæŒ‡ä»¤å‘å°„
<br>

å•æ ¸å¤„ç†å™¨çš„é¢‘ç‡å¾ˆéš¾å†æé«˜åï¼Œæ€§èƒ½æé«˜ç”± 
<br>

1.æŒ‡ä»¤çº§å¹¶è¡Œ
<br>

è½¬æ¢ä¸ºï¼ˆå¤šæ ¸å¤„ç†å™¨ï¼‰
<br>

2.æ•°æ®çº§å¹¶è¡Œ
<br>

3.çº¿ç¨‹çº§å¹¶è¡Œ
<br>

åº”ç”¨ç¨‹åºçš„å¹¶è¡Œï¼š
<br>

1.æ•°æ®çº§å¹¶è¡Œï¼šåŒæ—¶æ“ä½œè®¸å¤šæ•°æ®é¡¹
<br>

2.ä»»åŠ¡çº§å¹¶è¡Œï¼šå¹¶è¡Œçš„æ–¹å¼æ‰§è¡Œä»»åŠ¡
<br>

4ç§æ–¹å¼æ¥å¼€å‘è¿™2ç±»å¹¶è¡Œç¨‹åº
<br>

1.æŒ‡ä»¤çº§å¹¶è¡Œï¼šæµæ°´çº¿
<br>

2.å‘é‡ä½“ç³»ç»“æ„å’Œå›¾å½¢å¤„ç†å™¨ï¼šGPU
<br>

3.çº¿ç¨‹çº§å¹¶è¡Œ
<br>

4.è¯·æ±‚çº§å¹¶è¡Œ
<br>

æµæ°´çº¿åŸºç¡€ä¸ä¸­çº§æ¦‚å¿µï¼š
<br>

RISCæŒ‡ä»¤é›†çš„éæµæ°´çº¿å®ç°ï¼š
<br>

1. å–æŒ‡
2. è¯‘ç 
3. æ‰§è¡Œ
4. è®¿å­˜
5. å†™å›
<br>

å†’é™©é˜»ç¢äº†æŒ‡ä»¤çš„å®Œå…¨æµæ°´çº¿åŒ–ï¼š
<br>

1.ç»“æ„å†’é™©ï¼šç¡¬ä»¶ç»“æ„ï¼Œä¸èƒ½æ»¡è¶³å®Œå…¨æµæ°´çº¿åŒ–ï¼Œä¾‹å¦‚ä¸¤æ¡æŒ‡ä»¤æŸä¸ªé˜¶æ®µéœ€è¦åŒæ—¶æ“ä½œå†…å­˜ï¼Œä½†å¤„ç†å™¨åªæœ‰ä¸€ä¸ªå­˜å‚¨å™¨ã€‚-- æ°”æ³¡ï¼Œåœé¡¿
<br>

2.æ•°æ®å†’é™©ï¼šæŒ‡ä»¤ä¹‹é—´å­˜åœ¨æ•°æ®ä¾èµ–ã€‚--è½¬å‘ï¼ˆæµæ°´çº¿å†…éƒ¨çš„æ•°æ®æµè½¬ï¼Œè¯¸å¦‚å¯„å­˜å™¨é‡å‘½åï¼‰äº’é”
<br>

3.åˆ†æ”¯å†’é™©ï¼š...ä¸€ç³»åˆ—å¤„ç†æ–¹å¼ï¼Œæš‚æ—¶ä¸æ·±å…¥ã€‚
<br>

å…³äºæµæ°´çº¿çš„å…·ä½“å®ç°ä¹Ÿä¸å†æ·±å…¥ã€‚
<br>

æµæ°´çº¿ä¸‹çš„å¼‚å¸¸å¤„ç†ï¼šcsappä¸­ç®€å•ä»‹ç»äº†å‡ ä¸ªåŸºæœ¬çš„åŸåˆ™ï¼Œæ­¤å¤„å¦ä¸€ç§æ¨¡å‹å¯¹è¿™äº›è¿›è¡Œäº†æ¦‚è¿°ã€‚
<br>

ä¸€ä¸ªå®Œæ•´çš„æµæ°´çº¿ã€‚ç•¥è¿‡ã€‚
<br>

CAAQAï¼šä¸­å…³äºæµæ°´çº¿çš„ä»‹ç»æ˜æ˜¾æ›´åŠ æ·±å…¥ï¼Œä½†å½“å‰å¹¶æ²¡æœ‰è¶³å¤Ÿçš„æ—¶é—´ä»‹å…¥å…¶ä¸­ã€‚
<br>

æ¯«æ— ç–‘é—®ï¼ŒCAAQAå¯¹cpuçš„æè¿°æ›´åŠ çš„æ·±å…¥ï¼Œä»Šæ™šæ³¨å®šæ˜¯å®Œæˆä¸äº†çš„ã€‚å…ˆç†è§£é™æ€è°ƒåº¦ï¼Œå†ç†è§£åŠ¨æ€è°ƒåº¦ã€‚è¿˜æœ‰å¤§æ¦‚2å°æ—¶ï¼
<br>

æµæ°´çº¿é‡å æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹ -> æŒ‡ä»¤å¹¶è¡Œ
<br>

1.ç¡¬ä»¶åŠ¨æ€å‘ç°å¹¶è¡Œ
<br>

2.è½¯ä»¶ç¼–è¯‘ï¼Œé™æ€å‘ç°å¹¶è¡Œ
<br>

ä¸€äº›é˜»ç¢å¹¶è¡Œçš„åŸå› ï¼š
<br>

ç›¸å…³ï¼š-> ä¾èµ– -> é™åˆ¶äº†å¹¶è¡Œ
<br>

1.æ•°æ®ç›¸å…³
<br>

2.åç§°ç›¸å…³ ï¼ˆä¸¤æ¡æŒ‡ä»¤ä½¿ç”¨äº†ç›¸åŒçš„å¯„å­˜å™¨ï¼‰
<br>

å¯¹æ•°æ®å†’é™©çš„ç»†åŒ–ï¼š
<br>

è¯»äº†ä¸€ä¸ªæ—§å€¼
<br>

è¦†ç›–å†™
<br>

è¯»äº†ä¸€ä¸ªæ–°å€¼
<br>

3.æ§åˆ¶ç›¸å…³
<br>

å¯¹äºé™æ€è°ƒåº¦ï¼š
<br>

1.å¾ªç¯å±•å¼€
<br>

2.åˆ†æ”¯é¢„æµ‹
<br>

åŠ¨æ€è°ƒåº¦ï¼šé‡å¤´æˆ
<br>

ç¡¬ä»¶é‡æ–°å®‰æ’æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºä»¥å‡å°‘åœé¡¿ï¼Œå¹¶åŒæ—¶ä¿æŒæ•°æ®æµå’Œå¼‚å¸¸è¡Œä¸ºã€‚
<br>

æ˜¾è‘—æé«˜äº†ç¡¬ä»¶çš„å¤æ‚åº¦ã€‚
<br>

ç®€å•æµæ°´çº¿ï¼šæŒ‡ä»¤æŒ‰ç…§ç¨‹åºé¡ºåºå‘å°„ï¼Œä¸€æ¡çš„åœé¡¿ï¼Œå¯¼è‡´åç»­æ‰€æœ‰çš„åœé¡¿
<br>

ä¸€ä¸ªä¼˜åŒ–ï¼šä¸€æ¡æŒ‡ä»¤åœ¨å…¶æ“ä½œæ•°å¯ç”¨æ—¶å°±ç«‹å³æ‰§è¡Œ ä¹±åºæ‰§è¡Œï¼Œä¹±åºå®Œæˆ
<br>

ä¹±åºæ‰§è¡Œæ¶‰åŠï¼š
<br>

æ•°æ®å†’é™©ï¼šé”™è¯¯è¯»å–æ–°å€¼ã€è¦†ç›–å†™
<br>

å¼‚å¸¸å¤„ç†å˜å¾—ååˆ†å¤æ‚ï¼š
<br>

1.ä¿æŒé€»è¾‘ä¸€è‡´æ€§
<br>

2.éç²¾ç¡®å¼‚å¸¸ï¼ˆå‘ç”Ÿå¼‚å¸¸æ—¶çš„çŠ¶æ€ä¸æŒ‰é¡ºåºæ‰§è¡Œæ—¶çš„çŠ¶æ€ä¸ä¸€è‡´ï¼Œåé¢çš„æŒ‡ä»¤å·²ç»æ‰§è¡Œäº†ï¼Œæˆ–è€…å…ˆå‰çš„æŒ‡ä»¤è¿˜æ²¡æœ‰æ‰§è¡Œï¼‰
<br>

å°†ä¼ ç»Ÿçš„è¯‘ç é˜¶æ®µå¤§è‡´ç»†åŒ–ä¸ºï¼šå‘å°„ï¼ˆè¯‘ç &æ£€æŸ¥ç»“æ„å†’é™©ï¼‰+è¯»æ“ä½œæ•°ï¼ˆç›´åˆ°æ²¡æœ‰æ•°æ®å†’é™©å°±è¯»å–æ“ä½œæ•°ï¼‰
<br>

æŒ‡ä»¤é¡ºåºå‘å°„ï¼Œä½†åœ¨è¯»æ“ä½œæ•°é˜¶æ®µå¯èƒ½åœé¡¿æˆ–è€…æ—è·¯ï¼Œä»è€Œå¯¼è‡´ ä¹±åºæ‰§è¡ŒçŠ¶æ€ã€‚
<br>

åŠ¨æ€è°ƒåº¦çš„ç®—æ³•ï¼š ç•¥
<br>

çœŸéš¾ã€‚
<br>

ä¸è¿‡åˆ°æ­¤ä¸ºæ­¢ä¹Ÿèƒ½å¤§æ¦‚ç†è§£ä¹‹å‰çš„å†™xè¯»y & å†™yè¯»x ä¸ºä½•ä¼šå‡ºç°00äº†ï¼Œå› ä¸ºåœ¨å½“å‰çº¿ç¨‹å†…ï¼Œxä¸yä¸å­˜åœ¨æ•°æ®å†’é™©ï¼Œæ•…æ»¡è¶³ä¹±åºæ‰§è¡Œçš„æ¡ä»¶ã€‚å•ä¸ªcpuçš„åŠ¨æ€è°ƒåº¦ç®—æ³•æ— æ³•æ¢çŸ¥åˆ°å…¶ä»–cpuå¯¹å…±äº«æ•°æ®çš„ä¿®æ”¹ï¼æ‰€ä»¥å¹¶å‘å¸¦æ¥çš„ç¬¬ä¸‰ä¸ªé—®é¢˜æ˜¯ ä¸å¯è§ï¼Œè™½ç„¶è¡¨ç°å½¢å¼æ˜¯é¡ºåºä¸§å¤±ã€‚
<br>

å› ä¸ºä¸å¯è§ï¼Œè‡ªç„¶è€Œç„¶å¼•å‡ºäº†å†…å­˜æ¨¡å‹ã€‚
<br>

### memory model
<br>

https://research.swtch.com/mm
<br>

#### No1 ç¡¬ä»¶å†…å­˜æ¨¡å‹
<br>

è¿‡å»ï¼šåªéœ€è¦ç­‰å¾…ä¸‹ä¸€ä»£å¤„ç†å™¨ï¼Œç¨‹åºå°±å¯ä»¥è·‘åˆ°æ›´å¿«ï¼Œ-> ç¡¬ä»¶ä»¥æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„å½¢å¼æä¾›å¤šå¤„ç†å™¨ã€‚
<br>

å•çº¿ç¨‹ä¸­ç¡¬ä»¶ä¸ç¼–è¯‘å™¨çš„è®¸å¤šä¸å¯è§çš„ä¼˜åŒ–åœ¨å¤šçº¿ç¨‹ä¸­å˜å¾—ä¸å¯é ã€‚
<br>

```c
//thread1
x = 1;
done = 1;
<br>

//thread2
while(done == 0){}
print(x);
```
<br>

ç›´è§‚ä¸Šï¼Œä½†thread2 è·³å‡ºå¾ªç¯æ—¶ï¼Œä¸€å®šæ‰§è¡Œäº†x=1ï¼Œæ‰€ä»¥ä¸å¯èƒ½æ‰“å°å‡ºx = 0ï¼›
<br>

å®é™…æ˜¯ï¼Œå–å†³äºç¡¬ä»¶ä¸ç¼–è¯‘å™¨ã€‚
<br>

> It depends. It depends on the hardware, and it depends on the compiler. A direct line-for-line translation to assembly run on an x86 multiprocessor will always print 1. But a direct line-for-line translation to assembly run on an ARM or POWER multiprocessor can print 0. Also, no matter what the underlying hardware, standard compiler optimizations could make this program print 0 or go into an infinite loop.
<br>

å›åˆ°å‰é¢ï¼šå¹¶å‘æ˜¯åäººç±»ç›´è§‰çš„ã€‚
<br>

ç¡¬ä»¶å†…å­˜æ¨¡å‹
<br>

ç¼–ç¨‹è¯­è¨€å†…å­˜æ¨¡å‹
<br>

æœ€å¼€å§‹çš„å†…å­˜æ¨¡å‹æ˜¯é’ˆå¯¹æ±‡ç¼–è¯­è¨€çš„ï¼Œåæ¥ï¼Œjava/c å¼€å§‹å®šä¹‰è‡ªå·±çš„å†…å­˜æ¨¡å‹ï¼Œå†…å­˜æ¨¡å‹è¿˜éœ€è¦åŒ…å«ç¼–è¯‘å™¨ã€‚
<br>

å¤šå¤„ç†å™¨çš„é¡ºåºä¸€è‡´æ€§ã€‚
<br>

æˆ‘ä»¬å°†å‰é¢çš„é—®é¢˜è½¬åŒ–ä¸º: èƒ½å¦åœ¨r1 = 1 çš„æƒ…å†µä¸‹ï¼Œçœ‹åˆ°r2 = 0ï¼Ÿ
<br>

````c
//thread1
x = 1;
y = 1;
<br>

//thread2
<br>

r1 = y;
r2 = x;
````
<br>

çº¿ç¨‹å„è‡ªè¿è¡Œåœ¨ä¸“ç”¨å¤„ç†å™¨ä¸Šï¼Œç¼–è¯‘å™¨ä¸ä¼šé‡æ’åºã€‚
<br>

å¦‚æœæ»¡è¶³ç¡¬ä»¶æ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼Œæ‰§è¡Œåªä¼šæœ‰6åªå¯èƒ½çš„ç»“æœ
<br>

![image-20241120151302469](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241120151302469.png)
<br>

å¦‚æœç¡¬ä»¶æ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼Œr1 = 1ï¼Œr2 = 0 çš„æƒ…å†µæ°¸è¿œä¸ä¼šå‡ºç°ã€‚
<br>

å¯¹é¡ºåºä¸€è‡´æ€§çš„æŠ½è±¡ï¼Œå¯ä»¥æƒ³è±¡ä¸ºæ‰€æœ‰å¤„ç†å™¨éƒ½æ˜¯ç›´è¿å…±äº«å†…å­˜ï¼šsingle-use-at-a-time shared memory
<br>

![image-20241120151802359](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241120151802359.png)
<br>

ä¸¥æ ¼çš„é¡ºåºä¸€è‡´æ€§æ¨¡å‹ï¼Œä¼šé™åˆ¶ç¡¬ä»¶çš„æ‰§è¡Œé€Ÿåº¦ã€‚å˜ç§ä¹‹x86
<br>

![image-20241120154617377](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241120154617377.png)
<br>

ä¸€ä¸ªå†™çš„ç¼“å­˜é˜Ÿåˆ—ï¼Œå…ˆè¿›å…ˆå‡ºï¼Œè¯»å–æ•°æ®æ—¶ä¼˜å…ˆè¯»æœ¬çº¿ç¨‹å†™çš„ï¼Œç„¶åæ‰æ˜¯å…±äº«å†…å­˜ã€‚ä¸ºä»€ä¹ˆå«total store orderï¼Ÿ
<br>

å†…å­˜ä¸€è‡´æ€§æ¨¡å‹ï¼ˆå¦‚Total Store Orderï¼‰ç¡®ä¿äº†æ‰€æœ‰å¤„ç†å™¨çœ‹åˆ°çš„å†™å…¥æ“ä½œçš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœå¤„ç†å™¨P1å…ˆæ‰§è¡Œäº†å†™å…¥æ“ä½œAï¼Œç„¶åå¤„ç†å™¨P2æ‰§è¡Œäº†å†™å…¥æ“ä½œBï¼Œå¹¶ä¸”P1çš„å†™å…¥æ“ä½œå…ˆäºP2çš„å†™å…¥æ“ä½œåˆ°è¾¾å…±äº«å†…å­˜ï¼Œé‚£ä¹ˆæ‰€æœ‰å¤„ç†å™¨éƒ½å¿…é¡»æŒ‰ç…§Aå…ˆäºBçš„é¡ºåºè§‚å¯Ÿåˆ°è¿™äº›å†™å…¥æ“ä½œã€‚
<br>

P1å…ˆå†™a=1ï¼Œç„¶åP2å†å†™a=2ï¼Œä½†æ˜¯P2å…ˆåˆ°è¾¾å…±äº«å†…å­˜ã€‚ä¸Šè¿°å‡è®¾æ˜¯é”™è¯¯çš„ï¼ˆä¼šæœ‰å†…å­˜å±éšœï¼ˆmemory fencesï¼‰æˆ–å…¶ä»–åŒæ­¥æœºåˆ¶æ¥é¿å…ï¼Ÿï¼Ÿï¼‰ï¼Œå› ä¸ºTSOå†…å­˜æ¨¡å‹ï¼Œå¼ºè°ƒï¼Œæ‰€æœ‰çš„å¤„ç†å™¨**çœ‹åˆ°ï¼ˆå‘bufferé‡Œå†™ï¼Œå…¶ä»–å¤„ç†å™¨çœ‹ä¸åˆ°ï¼‰**çš„å†™é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œå› ä¸ºp1å…ˆå†™a=1ç„¶åp2 å†å†™a=2ï¼Œæ‰€ä»¥å¯¹æ‰€æœ‰å¤„ç†å™¨ï¼Œä¸€å®šæ˜¯å…ˆè§‚å¯Ÿåˆ°a=1ï¼Œç„¶åa=2.
<br>

x86æˆ–å…¶ä»–TSO å†…å­˜æ¨¡å‹ä¸­è§‚å¯Ÿä¸åˆ° r1=1ï¼Œr2=0:
<br>

1.The write queue guarantees that thread 1 writes x to memory before yï¼›
<br>

2.the system-wide agreement about the order of memory writes (the total store order) guarantees that thread 2 learns of xâ€™s new value before it learns of yâ€™s new valueï¼›
<br>

ä¸€ä¸ªTSOä¸ é¡ºåºä¸€è‡´æ€§å·®å¼‚çš„ä¾‹å­ï¼š
<br>

```c
//thread1
x = 1;
r1 = y;
<br>

//thread2
y = 1;
r2 = x;
```
<br>

æ˜¯å¦å¯ä»¥çœ‹è§ r1=0;r2=0
<br>

ä¸€è‡´æ€§æ¨¡å‹ï¼šä¸å¯èƒ½ï¼›å¯¹x/y çš„èµ‹å€¼ï¼Œä¸€å®šæœ‰ä¸€ä¸ªå…ˆæ‰§è¡Œï¼Œåé¢è¯»å–æ—¶ä¸€å®šæ˜¯è¯»å–çš„æ›´æ–°åçš„å€¼ã€‚
<br>

X86/TSOï¼šå¯èƒ½ï¼Œå› ä¸ºæœ‰write bufferï¼Œä»å…±äº«å†…å­˜è¯»å–çš„æ˜¯åˆå§‹å€¼ã€‚
<br>

ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸€èˆ¬ç¨‹åºæä¾› barrierï¼Œå¼ºåˆ¶åŒæ­¥ã€‚
<br>

ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œå¯ä»¥æ›´å¥½çš„è§£é‡Šä¸ºä»€ä¹ˆå«Total Store Order
<br>

```c
//thread1
x=1;
<br>

//thread2
y=1;
<br>

//thread3
r1 = x;
r2 = y;
<br>

//thread4
r3 = y;
r4 = x;
```
<br>

æ˜¯å¦å¯èƒ½ï¼šr1=1,r2=0; r3=1,r4=0?
<br>

ä¸€è‡´æ€§æ¨¡å‹ä¸TSO å‡ä¸èƒ½
<br>

r1=1,r2=0 æ„å‘³å¯¹äºthread3ï¼Œxå…ˆå†™ã€‚å› ä¸ºTSOï¼Œæ‰€ä»¥å¯¹thread4ï¼Œä¹Ÿä¸€å®šæ˜¯xå…ˆå†™ã€‚æ•…r4ä¸å¯èƒ½=0ï¼›
<br>

ARM/POWER Relaxed Memory Model
<br>

![image-20241120181447448](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241120181447448.png)
<br>

ä¸åšä»»ä½•ä¿éšœï¼Œå‰é¢çš„æ‰€æœ‰ä¾‹å­éƒ½æœ‰å¯èƒ½å‡ºç°ã€‚æ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰ä¸€ä¸ªå…±äº«å˜é‡çš„å‰¯æœ¬ï¼Œä½†ä¸åŒå¤„ç†å™¨ä¹‹é—´å‰¯æœ¬çš„åŒæ­¥æ˜¯å¯ä»¥ä»»æ„æ’åºçš„ï¼
<br>

å½“æˆ‘ä»¬ä¸“æ³¨äºå•ä¸ªå†…å­˜ä½ç½®æ—¶ï¼ŒRMMä¹Ÿæä¾›äº†ä¸€å®šçš„ä¿éšœ
<br>

```c
//thread1
x=1;
<br>

//thread2
x=2;
<br>

//thread3
r1=x;
r2=x;
<br>

//thread4
r3=x;
r4=x;
```
<br>

èƒ½å¦å‡ºç°r1=1,r2=2 ; r3=2,r4=1?
<br>

ä¸€è‡´æ€§ï¼šno
<br>

TSOï¼šno
<br>

RMMï¼šno
<br>

> The answer is no, even on ARM/POWER: threads in the system must agree about a total order for the writes to a single memory location. That is, threads must agree which writes overwrite other writes. This property is called called coherence. Without the coherence property, processors either disagree about the final result of memory or else report a memory location flip-flopping from one value to another and back to the first. It would be very difficult to program such a system.
<br>

coherence.
<br>

> ARMv8 strengthened the memory model by making it â€œmulticopy atomic
<br>

æœ€åæ–‡ç« å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ä¸»é¢˜ï¼šè‹¥æ’åºã€‚å‘ç”Ÿç«äº‰æ—¶ï¼ŒæŒ‰ç…§ä¸€å®šè§„åˆ™æ’åºã€‚
<br>

#### No2 ç¼–ç¨‹è¯­è¨€çš„å†…å­˜æ¨¡å‹
<br>

> Programming language memory models answer the question of what behaviors parallel programs can rely on to share memory between their threads
<br>

```c
//thread1
x = 1;
done = 1;
<br>

//thread2
while(done == 0){}
printf(x);
```
<br>

ç¨‹åºèƒ½å¦æŒ‰ç…§é¢„æœŸå®Œæˆæ‰“å°å‡º 1ï¼Ÿ
<br>

ç°ä»£å¤šçº¿ç¨‹è¯­è¨€ï¼ˆc/java/rust...ï¼‰çš„ä¸€äº›é€šç”¨å›ç­”ï¼š
<br>

1.é¦–å…ˆï¼Œå¦‚æœ x å’Œ done æ˜¯æ™®é€šå˜é‡ï¼Œåˆ™çº¿ç¨‹ 2 çš„å¾ªç¯å¯èƒ½æ°¸è¿œä¸ä¼šåœæ­¢ã€‚ä¸€ç§å¸¸è§çš„ç¼–è¯‘å™¨ä¼˜åŒ–æ˜¯åœ¨å˜é‡é¦–æ¬¡ä½¿ç”¨æ—¶å°†å…¶åŠ è½½åˆ° register ä¸­ï¼Œç„¶åå°½å¯èƒ½é•¿æ—¶é—´åœ°é‡ç”¨è¯¥ register ä»¥ä¾›å°†æ¥è®¿é—®è¯¥å˜é‡ã€‚å¦‚æœçº¿ç¨‹ 2 åœ¨çº¿ç¨‹ 1 æ‰§è¡Œä¹‹å‰å¤åˆ¶åˆ° done å¯„å­˜å™¨ä¸­ï¼Œåˆ™å®ƒå¯èƒ½ä¼šåœ¨æ•´ä¸ªå¾ªç¯ä¸­ç»§ç»­ä½¿ç”¨è¯¥å¯„å­˜å™¨ï¼Œè€Œä¸ä¼šæ³¨æ„åˆ°çº¿ç¨‹ 1 ç¨åä¿®æ”¹äº† done ã€‚
<br>

2.å…¶æ¬¡ï¼Œå³ä½¿çº¿ç¨‹ 2 çš„å¾ªç¯ç¡®å®åœæ­¢äº†ï¼Œåœ¨è§‚å¯Ÿåˆ° done=1åï¼Œå®ƒå¯èƒ½ä»ä¼šæ‰“å° x=0ã€‚ç¼–è¯‘å™¨é€šå¸¸æ ¹æ®ä¼˜åŒ–å¯å‘å¼æ–¹æ³•å¯¹ç¨‹åºè¯»å–å’Œå†™å…¥è¿›è¡Œé‡æ–°æ’åºï¼Œç”šè‡³ä»…æ ¹æ®ç”Ÿæˆä»£ç æ—¶éå†å“ˆå¸Œè¡¨æˆ–å…¶ä»–ä¸­é—´æ•°æ®ç»“æ„çš„æ–¹å¼ã€‚çº¿ç¨‹ 1 çš„ç¼–è¯‘ä»£ç å¯èƒ½æœ€ç»ˆå†™å…¥done=1 å…ˆäº x =1ï¼Œæˆ–è€…çº¿ç¨‹ 2 çš„ç¼–è¯‘ä»£ç å¯èƒ½å…ˆprintå†while ã€‚
<br>

> Modern languages provide special functionality, in the form of *atomic variables* or *atomic operations*, to allow a program to synchronize its threads
<br>

åŸå­å˜é‡ & åŸå­æ“ä½œï¼š
<br>

> - The compiled code for thread 1 must make sure that the write to `x` completes and is visible to other threads before the write to `done` becomes visible.
>
> x=1 å…ˆäº done = 1å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚
>
> - The compiled code for thread 2 must (re)read `done` on every iteration of the loop.
>
> å¾ªç¯ä¸­æ¯æ¬¡éƒ½è¦ä»å†…å­˜è¯»å–done
>
> - The compiled code for thread 2 must read from `x` after the reads from `done`.
>
> å½“æˆ‘è¯»åˆ°done=1 æ—¶ä¸€å®šå¯ä»¥è¯»åˆ° x =1
>
> - The compiled code must do whatever is necessary to disable hardware optimizations that might reintroduce any of those problems.
>
> åŸå­æ“ä½œ/åŸå­å˜é‡ï¼Œéœ€è¦é˜»æ­¢ç¡¬ä»¶çš„ä¼˜åŒ–ï¼ˆä¹±åºæ‰§è¡Œï¼‰
<br>

**Hardware, Litmus Tests, Happens Before, and DRF-SC**
<br>

å¤„ç†å™¨ä¼šå¯¹æŒ‡ä»¤åšæ–°çš„æ’åºï¼Œ`The gold standard is [sequential consistency](https://research.swtch.com/hwmm#sc), in which any execution must behave as if the programs executed on the different processors were simply interleaved in some order onto a single processor.`ç›®å‰æ²¡æœ‰é‡è¦çš„æ¶æ„æä¾›å®ƒï¼Œå› ä¸ºè¾ƒå¼±çš„ä¿è¯å®ç°äº†æ€§èƒ½æå‡
<br>

```c
// Thread 1           // Thread 2
x = 1                 r1 = y
y = 1                 r2 = x
```
<br>

r1=1,r2=0?
<br>

On sequentially consistent hardware: no.
On x86 (or other TSO): no.
On ARM/POWER: *yes!*
In any modern compiled language using ordinary variables: *yes!*
<br>

> In a modern language, the reordering that can happen during compilation makes this outcome possible no matter what the underlying hardware
<br>

ä»Šå¤©çš„å¤„ç†å»ä¸ä¿è¯ä¸¥æ ¼çš„é¡ºåºä¸€è‡´æ€§ï¼Œè€Œæ˜¯ä¿è¯[â€œdata-race-free sequential-consistencyâ€, or DRF-SC](https://research.swtch.com/hwmm#drf) 
<br>

ä¸€ä¸ªç³»ç»Ÿè¦ä¿è¯æ— æ•°æ®ç«äº‰çš„é¡ºåºä¸€è‡´æ€§ï¼Œéœ€è¦æä¾›*synchronizing instructions* ç”¨äºåœ¨ä¸åŒå¤„ç†å™¨ä¸Šæ‰§è¡Œçš„ä»£ç ä¹‹é—´åˆ›å»º happen before å…³ç³»ã€‚
<br>

<img src="https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241121120655712.png" alt="image-20241121120655712" style="zoom:50%;" />
<br>

åŒæ­¥æŒ‡ä»¤ï¼Œç”¨äºç¡®ä¿çº¿ç¨‹1çš„å†™ å…ˆäºçº¿ç¨‹2çš„è¯»å‘ç”Ÿã€‚æˆ–è€…è¯´å°†çº¿ç¨‹1å†™çš„ç»“æœåŒæ­¥ç»™çº¿ç¨‹2.
<br>

> Processors that provide DRF-SC (all of them, these days) guarantee that programs *without* data races behave as if they were running on a sequentially consistent architecture.
<br>

**ç¼–è¯‘å™¨ä¼˜åŒ–**
<br>

> It is generally accepted that a compiler can reorder ordinary reads from and writes to memory almost arbitrarily, provided the reordering cannot change the observed single-threaded execution of the code
<br>

```c
// Thread 1    // Thread 2    // Thread 3    // Thread 4
x = 1          x = 2          r1 = x         r3 = x
                              r2 = x         r4 = x
```
<br>

Can this program see r1=1,r2=2; r3=2,r4=1?
<br>

On sequentially consistent hardware: no.
On x86 (or other TSO): no.
On ARM/POWER: no. **coherence**
In any modern compiled language using ordinary variables: *yes!*
<br>

**Original Java Memory Model (1996)**
<br>

ç¬¬ä¸€ç‰ˆjavaè¯­è¨€è§„å®šï¼švolatile å˜é‡çš„æ‰€æœ‰è¯»å–å’Œå†™å…¥éƒ½éœ€è¦ç›´æ¥åœ¨ä¸»å†…å­˜ä¸­æŒ‰ç¨‹åºé¡ºåºæ‰§è¡Œ
<br>

ä½†æ˜¯volatileå˜é‡æ˜¯ non-synchronizing
<br>

```java
int x;
volatile int done;
<br>

// Thread 1           // Thread 2
x = 1;                while(done == 0) { /* loop */ }
done = 1;             print(x);
```
<br>

volatile ç¡®ä¿äº†ï¼Œå¾ªç¯ä¸€å®šå¯ä»¥è·³å‡ºï¼Œä½†å› ä¸ºæ˜¯éåŒæ­¥çš„ï¼Œæ•…ç¼–è¯‘å™¨è¿˜æ˜¯æœ‰å¯èƒ½å¯¹ `x` å’Œ `done` çš„èµ‹å€¼é‡æ–°æ’åº
<br>

javaåŸå§‹å†…å­˜æ¨¡å‹çš„å¦ä¸€ä¸ªç¼ºé™·å°±æ˜¯ï¼šå¼ºåˆ¶ä¸€è‡´æ€§ã€‚
<br>

```java
// p and q may or may not point at the same object.
int i = p.x;
// ... maybe another thread writes p.x at this point ...
int j = q.x;
int k = p.x;
```
<br>

å› ä¸ºå…¶ä»–çº¿ç¨‹æ›´æ–°äº†p.x,ä¸èƒ½å°†å…¶ä¼˜åŒ–ä¸ºï¼šk=i;
<br>

**New Java Memory Model (2004)**
<br>

ä¸€ä¸ªdata-race-free çš„ç¨‹åºï¼Œéœ€è¦åŒæ­¥æ“ä½œï¼Œå»ºç«‹ happens-before ï¼Œæ—¨åœ¨ä¸€ä¸ªçº¿ç¨‹å†™éåŸå­å˜é‡æ—¶å…¶ä»–çº¿ç¨‹ä¸ä¼šè¯»å†™è¯¥å˜é‡ã€‚javaä¸­åŒæ­¥æ“ä½œï¼š
<br>

1. The creation of a thread happens before the first action in the thread.
2. An unlock of mutex *m* happens before any subsequent lock of *m*.
3. A write to volatile variable *v* happens before any subsequent read of *v*.
<br>

> What does â€œsubsequentâ€ mean? Java defines that all lock, unlock, and volatile variable accesses behave as if they ocurred in some sequentially consistent interleaving, giving a total order over all those operations in the entire program. â€œSubsequentâ€ means later in that total order. That is: the total order over lock, unlock, and volatile variable accesses defines the meaning of subsequent, then subsequent defines which happens-before edges are created by a particular execution, and then the happens-before edges define whether that particular execution had a data race. If there is no race, then the execution behaves in a sequentially consistent manner.
<br>

javaå®šä¹‰äº†ä¸€ä¸ªæ€»çš„é¡ºåºï¼Œæ€»çš„é¡ºåºå®šä¹‰äº†Subsequentï¼Œé€šè¿‡Subsequentå®šä¹‰äº†happen-beforeï¼Œhappen-beforeåˆå®šä¹‰äº†å‘ç”Ÿdata race æ—¶çš„å…·ä½“è¡Œä¸ºã€‚
<br>

```java
// Thread 1           // Thread 2
x = 1                 y = 1
r1 = y                r2 = x
```
<br>

r1=1,r2=0?
<br>

On sequentially consistent hardware: no.
On x86 (or other TSO): *yes!*
On ARM/POWER: *yes!*
On Java using **volatiles**: no.
<br>

> In Java, for volatile variables `x` and `y`, the reads and writes cannot be reordered: one write has to come second, and the read that follows the second write must see the first write. If we didnâ€™t have the sequentially consistent requirementâ€”if, say, volatiles were only required to be coherentâ€”the two reads could miss the writes.
<br>

1.volatile ä¸ä¼šé‡æ’åº
<br>

2.volatile ä¸€å®šä¸€ä¸ªå…ˆå†™ï¼Œä¸€ä¸ªåå†™ï¼Œå¯¹åå†™å˜é‡çš„è¯»æ—¶ï¼Œä¸€å®šå¯ä»¥çœ‹åˆ°å…ˆå†™å˜é‡æ›´æ–°åçš„å€¼ã€‚
<br>

åé¢æ˜¯å¯¹javaå†…å­˜æ¨¡å‹çš„æ›´æ·±å…¥çš„è®²è§£ï¼Œæš‚æ—¶å°±ä¸äº†è§£äº†ã€‚
<br>

è¡¥å……ä¸€ä¸ªç›¸å¯¹å®Œæˆçš„happen-beforeï¼š
<br>

1.å•ä¸ªçº¿ç¨‹å†…ï¼Œå‰é¢ happen before åé¢
<br>

2.ä¸¤ä¸ªçº¿ç¨‹é—´ï¼Œvloatile å˜é‡çš„å†™ happen before åç»­å¯¹å…¶çš„è¯»
<br>

3.ä¸€ä¸ªé”çš„è§£é” happen before åç»­å¯¹å…¶çš„åŠ é”
<br>

4.thread.start()ï¼›startå‰çš„æ“ä½œ happen before æ–°å¼€å¯çš„çº¿ç¨‹
<br>

5.joinï¼Œçº¿ç¨‹çš„æ‰€æœ‰æ“ä½œï¼Œhappen before å¯¹è¯¥çº¿ç¨‹çš„join
<br>

6.çº¿ç¨‹ä¸­æ–­
<br>

7.å¯¹è±¡ç»ˆç»“
<br>

ruleï¼šä¼ é€’æ€§
<br>

**c++çš„å†…å­˜æ¨¡å‹**
<br>

æš‚æ—¶ç•¥è¿‡ã€‚
<br>

# 0x4ç†è§£å¹¶å‘ç¨‹åºçš„æ‰§è¡Œ
<br>

<img src="https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241118204753528.png" alt="image-20241118204753528" style="zoom:50%;" />
<br>

æ²¡æ³•ä¿è¯load ä¸ store æ˜¯åŸå­æ€§çš„ã€‚
<br>

peterson ç®—æ³•ã€‚
<br>

å‚è€ƒä¹¦ç±ï¼šã€ŠThe Art of Multiprocessor Programmingã€‹
<br>

bç«™æœ‰äººæåˆ°ä¸åŠ barrierä¸ºä»€ä¹ˆpeterson-simple è¿˜æ˜¯ä¼šæœ‰é—®é¢˜ï¼Ÿ
<br>

ä¸å‰é¢çš„å†…å­˜æ¨¡å‹ä¸å¯è§æ€§æœ‰å…³ã€‚å¦‚ä½•å‡†ç¡®çš„è§£é‡Šï¼Ÿå› ä¸ºä¸å­˜åœ¨æ•°æ®å†’é™©ï¼Œæ‰€ä»¥å…ˆåŠ è½½è¿›æ¥äº†å…±äº«å˜é‡ï¼Œä½†å…±äº«å˜é‡åœ¨åŠ è½½è¿›æ¥ååˆ°åç»­åˆ¤æ–­ä½¿ç”¨æœŸé—´å‘ç”Ÿäº†å˜åŒ–ã€‚è¯»å–äº†æ—§å€¼ã€‚
<br>

todoï¼šä¹‹å‰ç•™ä¸‹æ¥çš„å†…å­˜æ¨¡å‹ç›¸å…³æ–‡ç« ã€‚
<br>

todoï¼šproject NEMUå®éªŒ PA
<br>

python  generator = çŠ¶æ€æœº ï¼Œå…±äº«å…¨å±€å˜é‡
<br>

è½¬åŒ–ä¸º å›¾
<br>

ç¨‹åºæ€§è´¨ï¼š
<br>

Safety Propertiesï¼š ä»ä»»æ„èŠ‚ç‚¹å‡ºå‘ï¼Œåˆ°è¾¾ä¸äº†çº¢è‰²èŠ‚ç‚¹
<br>

Liveness Propertiesï¼šä»ä»»æ„çŠ¶æ€å‡ºå‘ï¼Œæœ‰é™æ­¥å†…åˆ°è¾¾è“è‰²/ç»¿è‰² èŠ‚ç‚¹
<br>

live lock ï¼Ÿ å¼ºè”é€šåˆ†é‡
<br>

# ç¬¬ä¸‰å‘¨é˜…è¯»ææ–™
<br>

## é”
<br>

ahaï¼Œå‰é¢çš„å†…å®¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®Œå…¨ä¸è®°å¾—è¿™ä¸ªäº†å‘¢ã€‚
<br>

é”çš„åŸºæœ¬æ€æƒ³ï¼šä¸€ä¸ªå˜é‡ï¼Œä¸ºç¨‹åºå‘˜æä¾›äº†æœ€å°ç¨‹åº¦çš„è°ƒåº¦æ§åˆ¶ã€‚
<br>

å¦‚ä½•å®ç°é”ï¼Ÿéœ€è¦ç¡¬ä»¶&æ“ä½œç³»ç»Ÿæä¾›å“ªäº›æ”¯æŒã€‚
<br>

å¦‚ä½•è¯„ä»·é”ï¼š
<br>

1. æœ€åŸºæœ¬çš„äº’æ–¥
2. å…¬å¹³æ€§ï¼Œæ˜¯å¦æœ‰çº¿ç¨‹è¢«é¥¿æ­»
3. æ€§èƒ½ï¼Œä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰ç«äº‰ï¼Œä¸€ä¸ªcpuå¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªcpuå¤šä¸ªçº¿ç¨‹ã€‚
<br>

æ–¹æ¡ˆï¼š
<br>

### interrupt
<br>

ä¿è¯ä¸´ç•ŒåŒºä»£ç ä¸ä¼šè¢«ä¸­æ–­ï¼ŒğŸ¤”ï¼Œåªèƒ½ç”¨äºå•å¤„ç†å™¨ã€‚
<br>

ç¡¬ä»¶åŸè¯­
<br>

### test-and-set 
<br>

åŸå­äº¤æ¢
<br>

æ²¡æœ‰ç¡¬ä»¶æ”¯æŒçš„åŸºæœ¬ç‰ˆæœ¬ï¼š
<br>

```c
typedef struct __lock_t { int flag; } lock_t;
<br>

 void init(lock_t *mutex) {
 // 0 -> lock is available, 1 -> held
 mutex->flag = 0;
 }
<br>

 void lock(lock_t *mutex) {
 while (mutex->flag == 1) // TEST the flag
 ; // spin-wait (do nothing)
 mutex->flag = 1; // now SET it!
 }
<br>

 void unlock(lock_t *mutex) { mutex->flag = 0;
```
<br>

1.æ— æ³•å®ç°åŸå­æ€§ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½è·³è¿‡äº†while
<br>

2.æ€§èƒ½å·®ï¼Œè‡ªæ—‹ç­‰å¾… spin-waiting
<br>

test-and-set:
```c
int test_and_set(int *old_ptr, int new) {
 	int old  = *old_ptr;
  *old_ptr = new;
  return old;
}
```
<br>

é€šè¿‡ç¡¬ä»¶ï¼ŒåŸå­æ€§çš„æ‰§è¡Œä¸Šè¿°æ–¹æ³•ã€‚
<br>

è§£å†³äº†ä¸Šé¢çš„è·å–&è®¾ç½® çš„éåŸå­æ€§é—®é¢˜ã€‚
<br>

æ­£ç¡®äº’æ–¥
<br>

æ²¡æœ‰å…¬å¹³æ€§
<br>

æ€§èƒ½ï¼šå•cpuæµªè´¹æå¤§ï¼Œå¤šcpuç›¸å¯¹è¾ƒå¥½
<br>

### compare-and-swap
<br>

```c
 int CompareAndSwap(int *ptr, int expected, int new) {
 int original = *ptr;
 if (original == expected)
 *ptr = new;
 return original;
 }
```
<br>

å¯ç”¨äº wait-free synchronization
<br>

å¦‚æœç”¨äºè‡ªæ—‹é” å‡ ä¹ç­‰ä»· test-and-set
<br>

### loadlinked - storeconditional
<br>

### fetch-and-add
<br>

questionï¼š
<br>

è‡ªæ—‹è¿‡å¤šï¼Œå¤ªå¤šçš„çº¿ç¨‹æµªè´¹cpuåœ¨whileä¸Šäº†ã€‚-- æ“ä½œç³»ç»ŸåŸè¯­ï¼šyield
<br>

å¶ç„¶æ€§ï¼šä¸€ç›´è‡ªæ—‹ï¼ˆæµªè´¹ï¼‰ï¼Œç«‹å³è®©å‡ºï¼ˆé¥¿æ­»ï¼‰
<br>

é˜Ÿåˆ—æ¥äº†ã€‚
<br>

ä¸€æ®µlinux æºç ï¼š
<br>

## æ¡ä»¶å˜é‡
<br>

å¸Œæœ›çº¿ç¨‹æ»¡è¶³æŸä¸ªæ¡ä»¶ä¹‹åå†ç»§ç»­æ‰§è¡Œ
<br>

æ¡ä»¶å˜é‡ï¼šä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œçº¿ç¨‹åŠ å…¥é˜Ÿåˆ—ï¼Œæ¡ä»¶æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹è¢«å”¤é†’ã€‚
<br>

P252:è°ƒç”¨signal&waitæ—¶ æœ€å¥½æ€»æ˜¯æŒæœ‰é”ã€‚
<br>

### ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼ˆæœ‰ç•Œç¼“å†²åŒºï¼‰
<br>

ç”Ÿäº§è€…æŠŠæ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…æŠŠæ•°æ®ä»ç¼“å†²åŒºå–èµ°ã€‚
<br>

ä¿¡å·mesaé‡Šä¹‰ï¼šæš—ç¤ºçŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†å¹¶ä¸ä¿è¯å¯¹äºå”¤é†’çš„çº¿ç¨‹çŠ¶æ€æ˜¯å…¶æœŸæœ›çš„ã€‚
<br>

å› ä¸ºmesaè¯­ä¹‰ï¼šæˆ‘ä»¬æ€»æ˜¯ç”¨whileä»£æ›¿ifï¼ˆwaitï¼‰ã€‚
<br>

ä¾‹å­p259ï¼š
<br>

è¦†ç›–æ¡ä»¶ï¼šå¹¿æ’­ã€‚å”¤é†’æ‰€æœ‰æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ã€‚
<br>

## ä¿¡å·é‡
<br>

### é”
<br>

äºŒå€¼ä¿¡å·é‡
<br>

init 1
<br>

### æ¡ä»¶å˜é‡
<br>

init 0
<br>

### ç”Ÿäº§è€…/æ¶ˆè´¹è€…
<br>

ä¿¡å·é‡+äº’æ–¥é”
<br>

### è¯»å†™é”
<br>

ç¬¬ä¸€ä¸ªè¯»è€…è·å–å†™é”ï¼Œæœ€åä¸€ä¸ªè¯»è€…é‡Šæ”¾å†™é”ã€‚è¯»å¯ä»¥å¹¶å‘ã€‚
<br>

å†™éœ€è¦è·å–å†™é”ã€‚
<br>

è¯»è€…å®¹æ˜“é¥¿æ­»å†™è€…ã€‚
<br>

# 0x5 äº’æ–¥
<br>

äº’æ–¥çš„å›°éš¾ï¼šä¸èƒ½åŒæ—¶ è¯»/å†™ å…±äº«å†…å­˜ã€‚
<br>

ç¡¬ä»¶æä¾›åŸå­æŒ‡ä»¤ï¼šload & store ï¼šhttps://en.cppreference.com/w/cpp/header/stdatomic.h
<br>

```c
void Tsum() {
  for (int i = 0; i < N; i++) {
    asm volatile("lock addq $1, %0": "+m"(sum));
  }
}
```
<br>

x86æ±‡ç¼–æŒ‡ä»¤ï¼šlock å‰ç¼€ ç¡®ä¿äº†åŸå­æ€§&å†…å­˜å±éšœ
<br>

**è‡ªæ—‹é”ï¼š**
<br>

model-checker spin-lock.pyã€‚https://jyywiki.cn/OS/2022/slides/5.slides.html#/2/5
<br>

ç¡¬ä»¶ï¼š
<br>

lockæŒ‡ä»¤ï¼ˆåŸå­æŒ‡ä»¤ï¼‰ï¼Œæ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„ï¼Œå‰ä¸€ä¸ªlockçš„æ“ä½œå¯¹åç»­çš„lockå¯è§ã€‚æ— è®ºæœ‰å¤šå°‘ä¸ªæ ¸ã€‚åŸå­æŒ‡ä»¤å¯ä»¥ç†è§£ä¸ºä¸²è¡ŒåŒ–ï¼Œä¸å­˜åœ¨å¹¶å‘ã€‚
<br>

load
<br>

exec
<br>

store
<br>

X86:ç¼“å­˜ä¸€è‡´æ€§ ä¸ lockï¼ˆ80486 æ€»çº¿æ§åˆ¶é”ï¼‰
<br>

risc-vï¼šLoad-Reserved/Store-Conditional (LR/SC)
<br>

æ ‡è®°ï¼šreserved
<br>

exec
<br>

storeæ—¶ï¼Œæ£€æŸ¥æ ‡è®°è¿˜åœ¨æ²¡ï¼Œä¸€æ—¦æ ‡è®°æ²¡äº†å°±ä¸æ‰§è¡Œå†™å…¥
<br>

è‡ªæ—‹é”æ€§èƒ½å½±å“ï¼š
<br>

0:åŸå­æ“ä½œè§¦å‘ç¼“å­˜åŒæ­¥
<br>

1:ç©ºè½¬ï¼Œçº¿ç¨‹è¶Šå¤šï¼Œæµªè´¹çš„è¶Šå¤š
<br>

2:è·å–é”çš„çº¿ç¨‹è¢«cpuåˆ‡å‡ºå»äº†ï¼Œ100%æµªè´¹
<br>

sum-scalability çº¿ç¨‹è¶Šå¤šï¼Œè¿è¡Œçš„é€Ÿåº¦æ›´æ…¢ã€‚
<br>

é™¤äº†æ—¶é—´å¤æ‚åº¦ä¸ç©ºé—´å¤æ‚åº¦å¤–ï¼Œè¿˜æœ‰ï¼šScalability
<br>

ä½¿ç”¨åœºæ™¯ï¼š
<br>

![image-20241126220212959](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241126220212959.png)
<br>

**äº’æ–¥é”ï¼š**
<br>

ä¹Ÿå«ç¡çœ é”ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œé¿å…åˆ‡æ¢ä¸è‡ªé€‰ï¼Œæ²¡æœ‰è·å–é”çš„çº¿ç¨‹ç›´æ¥ç¡çœ ã€‚
<br>

å¦‚ä½•å®ç°é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥å‘¢ï¼Ÿ
<br>

æŠŠé”çš„å®ç°æ”¾åˆ°æ“ä½œç³»ç»Ÿï¼Œcè¯­è¨€åªè´Ÿè´£execã€‚
<br>

![image-20241126222619396](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241126222619396.png)
<br>

è‡ªæ—‹ä¸ç¡çœ  ç»“åˆ futexï¼šå¤±è´¥whileæ—¶ï¼Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨
<br>

![image-20241126223108055](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241126223108055.png)
<br>

è§£å†³é—®é¢˜ï¼Œæœ€é‡è¦çš„æ˜¯ç†è§£é—®é¢˜ï¼Œç†è§£é—®é¢˜æœ€é‡è¦çš„æ˜¯çŸ¥é“é—®é¢˜çš„å‡è®¾ï¼›
<br>

è§£å†³æå‡ºé—®é¢˜çš„äººï¼šæ”¹å˜å‡è®¾ã€‚
<br>

# 0x6 åŒæ­¥
<br>

çº¿ç¨‹åŒæ­¥ï¼šæŸä¸ªæ—¶é—´ç‚¹ï¼ŒçŠ¶æ€äº’çŸ¥
<br>

Todo:ç†è§£ modelcheckï¼Œå®Œæˆ https://jyywiki.cn/OS/2022/slides/6.slides.html#/1/4
<br>

ç”Ÿäº§è€…/æ¶ˆè´¹è€…
<br>

æ¡ä»¶å˜é‡
<br>

If -> while
<br>

ä¸‡èƒ½ï¼šwhile æ£€æµ‹æ¡ä»¶å˜é‡ï¼Œ+ broadcast
<br>

åªæœ‰ä¸€ä¸ªå•ä½èµ„æºçš„æ—¶å€™ï¼Œä½¿ç”¨ä¿¡å·é‡æ¯”è¾ƒåˆé€‚ã€‚ 
<br>

Todo:æœ‰æ„æ€ğŸ¤” æ¡ä»¶å˜é‡ä½œä¸š https://jyywiki.cn/OS/2022/slides/6.slides.html#/2/6
<br>

å“²å­¦å®¶åƒé¥­é—®é¢˜ï¼š
<br>

æ¯ä¸ªå‰å­ä¸Šé”+å…ˆå·¦æ‰‹å†å³æ‰‹=æ­»é”
<br>

ä¹¦ä¸­ï¼šä»¥ä¸ºé¡ºåºä¿®æ­£
<br>

pptï¼š
<br>

1.ä¸‡èƒ½ï¼Œä¸€æŠŠé”ï¼Œå“²å­¦å®¶è·å–äº†é”æ‰èƒ½å°è¯•æ‹¿å‰å­ã€‚
<br>

2.ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼šä¸€ä¸ªwaiterã€‚
<br>

> å®šå¾‹ï¼šPremature optimization is the root of all evil (D. E. Knuth)
<br>

Job queue å¯ä»¥å®ç°å‡ ä¹ä»»ä½•å¹¶è¡Œç®—æ³•
<br>

# ç¬¬å››å‘¨é˜…è¯»ææ–™
<br>

## 29å¹¶å‘æ•°æ®ç»“æ„
<br>

Crux:å¦‚ä½•æ·»åŠ é”åˆ°æ•°æ®ç»“æ„
<br>

æ•°æ®ç»“æ„->çº¿ç¨‹å®‰å…¨ ï¼š1.æ­£ç¡®æ€§ï¼Œ2.æ•ˆç‡
<br>

### è®¡æ•°å™¨
<br>

ç®€å•æ‹“å±•ï¼šåŠ é”çš„è®¡æ•°å™¨
<br>

æ•ˆç‡æµ‹è¯•ï¼šç†æƒ³çŠ¶æ€=å¤šçº¿ç¨‹è¿è¡Œçš„ä¸å•çº¿ç¨‹åŒæ ·å¿«
<br>

æ‡’æƒ°è®¡æ•°å™¨sloppy counterï¼š
<br>

å¤šä¸ªå±€éƒ¨è®¡æ•°å™¨ï¼Œä¸€ä¸ªå…¨å±€è®¡æ•°å™¨ï¼Œé˜ˆå€¼ æ§åˆ¶å±€éƒ¨ä¸å…¨å±€ä¹‹é—´çš„åŒæ­¥ã€‚
<br>

### å¹¶å‘é“¾è¡¨
<br>

ç®€å•å®ç°ï¼šä¸€ä¸ªé“¾è¡¨ä¸€ä¸ªé”
<br>

æ‹“å±•ï¼šhand-over-hand lock(lock coupling) è¿‡æ‰‹é”ï¼ˆè€¦åˆé”ï¼‰ï¼Œé“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªé”
<br>

### å¹¶å‘é˜Ÿåˆ—
<br>

### å¹¶å‘æ•£åˆ—è¡¨
<br>

### Take-away message
<br>

å…ˆç”¨ä¸€æŠŠå¤§é”ï¼Œå®ç°æ­£ç¡®çš„åŒæ­¥ï¼Œç›´åˆ°é‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œå†å»ä¼˜åŒ–åˆ°æ»¡è¶³éœ€æ±‚ã€‚
<br>

## 32å¸¸è§å¹¶å‘é—®é¢˜
<br>

### éæ­»é”ç¼ºé™·
<br>

1. è¿ååŸå­æ€§ï¼Œä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œä¸€ä¸ªçº¿ç¨‹è®¾ç½®ï¼Œå´æ²¡æœ‰é”
2. è¿åé¡ºåºæ€§ï¼Œä¸€ä¸ªçº¿ç¨‹åˆ›å»ºï¼Œä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚æ¡ä»¶å˜é‡
<br>

### æ­»é”ç¼ºé™·
<br>

äº§ç”Ÿæ­»é”çš„å››ä¸ªæ¡ä»¶ï¼š
<br>

1. äº’æ–¥
2. æŒæœ‰å¹¶ç­‰å¾…
3. ä¸å¯è¢«æŠ¢å 
4. å¾ªç¯ç­‰å¾…
<br>

1. å¾ªç¯ï¼šå…¨åºã€ååº ï¼Ÿ  é”çš„åœ°å€æ¥ç¡®å®šåŠ é”é¡ºåº
<br>

2. æŒæœ‰å¹¶ç­‰å¾…ï¼šæ›´å¤§çš„é”ï¼Œä¸é€‚ç”¨å°è£…
<br>

3. ä¸å¯è¢«æŠ¢å ï¼štrylock  æ³¨æ„æ´»é”
<br>

4. äº’æ–¥ï¼šæ— é”æ•°æ®ç»“æ„
<br>

5. é€šè¿‡è°ƒåº¦é¿å…æ­»é”ï¼ŒDijkstra é“¶è¡Œå®¶ç®—æ³•ã€‚
6. å…è®¸æ­»é”ï¼Œå‘ç”Ÿæ—¶å†æ¢å¤
<br>

> TOM WESTå®šå¾‹ï¼šä¸è¦æ€»æ˜¯å®Œç¾ï¼Œä¸æ˜¯æ‰€æœ‰å€¼å¾—åšçš„äº‹æƒ…éƒ½å€¼å¾—åšå¥½ã€‚
<br>

## 33åŸºäºäº‹ä»¶çš„å¹¶å‘
<br>

Crux :ä¸ç”¨çº¿ç¨‹ï¼Œå¦‚ä½•æ„å»ºå¹¶å‘æœåŠ¡å™¨
<br>

1.ç­‰å¾…æŸäº‹å‘ç”Ÿ
<br>

2.æ£€æŸ¥äº‹ä»¶ç±»å‹
<br>

3.å¤„ç†äº‹ä»¶
<br>

äº‹ä»¶å¾ªç¯:
<br>

```c
while (1) {
		events = getEvents();
		for (e in events)
				processEvent(e);
}
```
<br>

å¤„ç†ç¨‹åºï¼šç³»ç»Ÿå”¯ä¸€æ´»åŠ¨ï¼Œéå¹¶å‘
<br>

è°ƒåº¦ï¼šæ˜¾ç¤ºå†³å®šæ¥ä¸‹æ¥å¤„ç†é‚£ä»¶äº‹
<br>

Key:ä¸å…è®¸å¤„ç†æŸä¸ªäº‹ä»¶æ—¶å‘ç”Ÿé˜»å¡è°ƒç”¨ã€‚
<br>

åŸºäºäº‹ä»¶çš„é—®é¢˜ï¼š
<br>

1. å¼‚æ­¥IOï¼šå¤„ç†ï¼šå‘èµ·ioè¯·æ±‚åç«‹å³è¿”å›ï¼Œæä¾› å…¶ä»–å‡½æ•°æ£€æµ‹ioè¯·æ±‚æ˜¯å¦å·²ç»å¤„ç†å®Œ/unix signal
2. çŠ¶æ€ç®¡ç†ï¼šå‘å‡ºå¼‚æ­¥IOæ—¶ï¼Œæ‰“åŒ…ç¨‹åºçŠ¶æ€ï¼Œä»¥ä¾¿IOå¤„ç†å®Œåä½¿ç”¨ã€‚æ‰‹å·¥ç®¡ç†stackã€‚
3. å…¶ä»–é—®é¢˜ï¼šå•cpuè½¬å‘å¤šcpuæ—¶ï¼Œå¿…é¡»è¦å¹¶å‘ã€‚ä¸ä¸šåŠ¡é«˜åº¦è€¦åˆã€‚
<br>

# 0x7çœŸå®ä¸–ç•Œçš„å¹¶å‘
<br>

é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶å‘
<br>

LCSï¼šLongest Common Subsequenceã€‚kmp
<br>

ä»»åŠ¡åˆ†è§£ï¼š
<br>

è®¡ç®—å›¾ å¹¶è¡ŒåŒ–
<br>

1. ä»»åŠ¡å¦‚ä½•åˆ†é…åˆ°çº¿ç¨‹
2. çº¿ç¨‹é—´å¦‚ä½•äº¤äº’
<br>

 ç¤ºä¾‹ https://jyywiki.cn/pages/OS/2022/demos/mandelbrot.c
<br>

æ•°æ®ä¸­å¿ƒé‡Œçš„å¹¶å‘
<br>

åœ¨æœåŠ¡æµ·é‡åœ°ç†åˆ†å¸ƒè¯·æ±‚çš„å‰æä¸‹
<br>

- æ•°æ®è¦ä¿æŒä¸€è‡´ (Consistency)
- æœåŠ¡æ—¶åˆ»ä¿æŒå¯ç”¨ (Availability)
- å®¹å¿æœºå™¨ç¦»çº¿ (Partition tolerance)
<br>

ä¸€å°è®¡ç®—æœºçš„å¹¶å‘
<br>

å…³é”®æŒ‡æ ‡ï¼šQPS, tail latency
<br>

çº¿ç¨‹ï¼šèµ„æºå¼€é”€å¤§
<br>

åç¨‹ï¼šä¸€æ—¦blocké˜»ç¢æ•´ä¸ªçº¿ç¨‹
<br>

goï¼šGoroutineæ¦‚å¿µä¸Šæ˜¯çº¿ç¨‹ï¼Œå®é™…æ˜¯çº¿ç¨‹å’Œåç¨‹çš„æ··åˆä½“
<br>

ä¸€ä¸ªcpuä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹ä¸‹é¢æ— æ•°åç¨‹ï¼Œä¸€æ—¦blockï¼Œç«‹åˆ»yeildï¼Œå‡ ä¹100%å ç”¨cpuï¼Œcpuä¸Šéƒ½æ²¡æœ‰çº¿ç¨‹åˆ‡æ¢
<br>

åŸå­æ“ä½œ -> æ¡ä»¶å˜é‡ -> ä»»ä½•å¹¶å‘ç®—æ³•
<br>

goï¼š
<br>

![image-20241202230649822](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241202230649822.png)
<br>

å•çº¿ç¨‹+äº‹ä»¶æ¨¡å‹
<br>

promiseæµç¨‹å›¾
<br>

# 0x8å¹¶å‘bugåŠåº”å¯¹
<br>

è½¯ä»¶ï¼šéœ€æ±‚åœ¨æ•°å­—ä¸–ç•Œçš„æŠ•å½±ã€‚
<br>

bugå¤šï¼šç¼–ç¨‹è¯­è¨€çš„ç¼ºé™·ï¼Œåªç®¡ â€œç¿»è¯‘â€ ä»£ç ï¼Œä¸ç®¡å’Œå®é™…éœ€æ±‚ (è§„çº¦) æ˜¯å¦åŒ¹é…ã€‚æŠ•å½±çš„è¿‡ç¨‹ï¼Œè®¸å¤šä¿¡æ¯ä¸¢å¤±äº†
<br>

å§‹ç»ˆå‡å®šè‡ªå·±çš„ä»£ç æ˜¯é”™çš„ï¼Œä¸åœçš„å»è¯æ˜ã€‚
<br>

å¤šassertï¼Œç›¸äº’å°è¯
<br>

æ­»é”ï¼š
<br>

spinlockï¼šaaï¼Œè¿˜æ²¡é‡Šæ”¾é”ï¼Œç¨‹åºä¸­æ–­äº†ï¼Œå¤„ç†ç¨‹åºä¹Ÿéœ€è¦è¯¥é”ã€‚åŠ é”åå¦‚ä½•é¿å…ä¸­æ–­ï¼Ÿ
<br>

abbaï¼šé¡ºåº
<br>

ç†è§£ https://jyywiki.cn/pages/OS/2022/demos/spinlock-xv6.c
<br>

todo lockdep æ£€æµ‹æ­»é”
<br>

todo Thread Sanitizer æ£€æµ‹æ•°æ®ç«äº‰
<br>

è¿™ä¸€éƒ¨åˆ†ï¼šæ”¾å¼ƒ--ä¸è¦æ€»æ˜¯å®Œç¾ï¼Œä¸æ˜¯æ‰€æœ‰å€¼å¾—åšçš„äº‹æƒ…éƒ½å€¼å¾—åšå¥½ã€‚
<br>

**åŠ¨æ€ç¨‹åºåˆ†æ**ã€‚åŠ¨æ€åˆ†æå·¥å…·ï¼šSanitizers https://jyywiki.cn/OS/2022/slides/8.slides.html#/5/5
<br>

gcc ç¼–è¯‘é€‰é¡¹ 
<br>

# 0x9æ“ä½œç³»ç»Ÿçš„çŠ¶æ€æœºæ¨¡å‹
<br>

æ™®é€šçš„cç¨‹åºï¼Œç”±æ“ä½œç³»ç»Ÿè´Ÿè´£åŠ è½½ç„¶åæ‰§è¡Œï¼Œæ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åºï¼Œå®ƒåˆç”±è°åŠ è½½ï¼Ÿ
<br>

todoï¼šå…¨ç³»ç»Ÿæ¨¡æ‹Ÿå™¨æ˜¯ä»€ä¹ˆï¼Ÿ
<br>

æœ€å°cä»£ç ï¼š[minimal.S](https://jyywiki.cn/pages/OS/2022/demos/minimal.S)
<br>

1.å¦‚ä½•æŠŠè¿™æ®µä»£ç åŠ è½½è¿›å…¥å†…å­˜ï¼Ÿ
<br>

2.å¿…é¡»è¦æä¾›ç±»ä¼¼äºsystemcall ä¹‹ç±»çš„æ–¹æ³•
<br>

è½¯ç¡¬ä»¶çš„çº¦å®šï¼š
<br>

æ¦‚å¿µï¼šcpu stateï¼šå„ç§å¯„å­˜å™¨ 
<br>

resetåï¼Œpcä¸€å®šæŒ‡å‘æŸä¸ªåœ°æ–¹
<br>

è½¯ä»¶ä¸ç¡¬ä»¶è¿æ¥ï¼šcpu reset åpc æŒ‡å‘ä¸€æ¡æœ‰æ•ˆçš„æŒ‡ä»¤ã€‚
<br>

![image-20241208151122234](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241208151122234.png)
<br>

X86: ä¸€èˆ¬reset åpc æŒ‡å‘0xffff0ï¼ˆæŒ‡å‘å›ºä»¶ä¸Šä¸€æ®µç¨‹åºçš„è·³è½¬æŒ‡ä»¤ï¼Œç”µè„‘å¯åŠ¨è¿è¡Œçš„ç¬¬ä¸€ä¸ªè½¯ä»¶ï¼‰
<br>

firmwareï¼š
<br>

1.æ‰«æç¡¬ä»¶
<br>

2.æ‰¾åˆ°æœ‰æ“ä½œç³»ç»Ÿçš„ç¡¬ä»¶
<br>

3.åŠ è½½æ“ä½œç³»ç»Ÿï¼Œå‰©ä½™ä¸€åˆ‡ï¼Œäº¤ç»™æ“ä½œç³»ç»Ÿ
<br>

bios/uefi
<br>

legacy biosï¼š
<br>

1.çº¦å®šï¼šå¯åŠ¨ç£ç›˜çš„å‰512å­—èŠ‚=MBRï¼ˆmaster boot recordï¼‰
<br>

2.ç”±firmware å°†å…¶æ¬åˆ°ç‰©ç†å†…å­˜çš„0x7c00ï¼ˆfirmware ä¸æ“ä½œç³»ç»Ÿçš„ç¬¬ä¸€æ¬¡ä¹Ÿæ˜¯å”¯ä¸€ä¸€æ¬¡æ¡æ‰‹ï¼‰ã€‚
<br>

æ­¤æ—¶çŠ¶æ€ï¼š
<br>

![image-20241208221954339](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20241208221954339.png)
<br>

qemuï¼ŒæŸ¥çœ‹å¯åŠ¨è¿‡ç¨‹çš„ä»£ç ï¼š0x9 42åˆ†é’Ÿã€‚
<br>

åœ¨helloé•œåƒç›®å½•æ–°å¢bootloader.gdb 
<br>

```gdb
target remote localhost:1234
break *0x7c00
```
<br>

æ–°å¢shell è„šæœ¬
<br>

```shell
#!/bin/bash
<br>

qemu-system-x86_64 \
        -machine accel=tcg \
        -S -s \
        -drive format=raw,file=./hello-x86_64-qemu &
pid=$!
<br>

gdb -x bootloader.gdb; kill -9 $!
```
<br>

```gdb
 wa *0x7c00
 x/10i ($cs*16 + $rip)
 x/16xb 0x7c00
```
<br>

æŸ¥çœ‹é•œåƒ
<br>

```vi
vi hello-x86_64-qemu
<br>

%!xxd #è½¬æˆ16è¿›åˆ¶é˜…è¯»ï¼Œå†…å­˜0x7c00 å¤„çš„ä»£ç çœŸçš„å°±æ˜¯è·Ÿé•œåƒä¸€è‡´ï¼
```
<br>

å‰é¢è®²äº†å¯åŠ¨åŠ è½½ï¼šåˆå§‹åŒ–æ“ä½œç³»ç»ŸçŠ¶æ€æœº
<br>

ä¼ å¥‡é»‘å®¢ï¼šqemu ffmpeg
<br>

æ“ä½œç³»ç»Ÿï¼š
<br>

reset -> bios -> bootloader -> main
<br>

ã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹
<br>

todoï¼šç†è§£thread-os.chttps://jyywiki.cn/pages/OS/2022/demos/thread-os.c
<br>

hard
<br>

mpe_init(mp_entry);//ç»™æ¯ä¸ªcpuè¿è¡Œmp_entry,åˆå§‹åŒ–è¿›ç¨‹ç©ºé—´ï¼Œè®¾ç½®å¥½pcï¼Ÿ é‚£ä¹ˆæ­¤æ—¶è¿è¡Œmainçš„è¿™ä¸ªcpuå‘¢ï¼Ÿ
<br>

cpu(reset) -> bios ->bootloader ->main 
<br>

æ“ä½œç³»ç»Ÿçš„çŠ¶æ€æœºæ¨¡å‹ï¼š
<br>

1.mpe_init ä¹‹å‰çš„å…¨å±€çŠ¶æ€+æ¯ä¸ªcpuçš„å¯„å­˜å™¨è¢«mp_entryåˆå§‹åŒ–ä¹‹åçš„çŠ¶æ€
<br>

2.ç„¶åæ“ä½œç³»ç»Ÿå¯ä»¥é€‰æ‹©cpu1æ‰§è¡Œï¼Œæˆ–è€…cpu2æ‰§è¡Œ...
<br>

ä¸­æ–­ï¼šå°†å½“å‰cpuå¯„å­˜å™¨çŠ¶æ€æš‚å­˜ï¼Œç„¶åè¿è¡Œä¸­æ–­å¤„ç†ç¨‹åº
<br>

# 0xAçŠ¶æ€æœºæ¨¡å‹çš„åº”ç”¨
<br>

https://jyywiki.cn/pages/OS/2022/demos/ilp-demo.c
<br>

å¯ä»¥æµ‹è¯•cpu å®é™…1sèƒ½æ‰§è¡Œå¤šå°‘æŒ‡ä»¤ã€‚
<br>

amazing:
<br>

ç¨‹åºæ˜¯çŠ¶æ€æœºï¼Œåˆå§‹çŠ¶æ€+æŒ‡ä»¤ï¼ˆç¡®å®šæ€§çš„æŒ‡ä»¤ï¼‰= ä¸€å®šå¯ä»¥å¤ç°è¿‡ç¨‹
<br>

ä¸€èˆ¬å¤æ‚ç¨‹åºè¿˜æœ‰ä¸€ç±»ï¼šrdrand / systemcall ç­‰ä¸ç¡®å®šæ€§çš„æŒ‡ä»¤ï¼Œå¦‚ä½•å¤ç°å‘¢ï¼Ÿ -- åªéœ€è¦è®°å½•å…¶ç»“æœ
<br>

ç»è¿‡næ¡ç¡®å®šæ€§æŒ‡ä»¤ï¼Œæ‰§è¡Œä¸ç¡®å®šæ€§æŒ‡ä»¤açš„åˆ°ç»“æœbã€‚è®°å½•ï¼šåˆå§‹çŠ¶æ€+æŒ‡ä»¤ï¼ˆç¡®å®šæ€§ï¼‰+ï¼ˆæŒ‡ä»¤æ•°+ç»“æœï¼‰=å¤ç°
<br>

Record & replayï¼š
<br>

![image-20250112142835179](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20250112142835179.png)
<br>

![image-20250112142755121](https://cdn.jsdelivr.net/gh/liaozk-wiki/md_img/md/image-20250112142755121.png)
<br>

linux profileï¼š
<br>

Linux Kernel perf (æ”¯æŒç¡¬ä»¶ PMU) - [ilp-demo.c](https://jyywiki.cn/pages/OS/2022/demos/ilp-demo.c)
<br>

- perf list, perf stat (-e), perf record, perf report
<br>

model checker
<br>

ä¸€äº›çœŸæ­£çš„ model checkers
<br>

- [TLA+](https://lamport.azurewebsites.net/tla/tla.html) by Leslie Lamport;
- [Java PathFinder (JFP)](https://ti.arc.nasa.gov/tech/rse/vandv/jpf/) å’Œ [SPIN](http://spinroot.com/)
<br>

[KLEE: Unassisted and automatic generation of high-coverage tests for complex systems programs](https://dl.acm.org/doi/10.5555/1855741.1855756)
<br>

çº¦æŸæ±‚è§£å™¨