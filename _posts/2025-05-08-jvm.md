---
layout: post
category: jvm
---





95å¹´javaè¯ç”Ÿ

06å¹´Hadoopæ¨ªç©ºå‡ºä¸–ï¼Œåº•å±‚ç”¨javaå®Œæˆmap-reduceï¼Œjavaæ­ä¸Šæµ·é‡æ•°æ®çš„å¿«è½¦

08å¹´å®‰å“é™ä¸´åœ°è¡¨ï¼Œgoogleçš„æ”¯æŒä¸‹javaå†åº¦æ¥åˆ°é«˜å³°

25å¹´è¯ç”Ÿ30å¹´åæ¯ä¸ªç¨‹åºå‘˜éƒ½è¦æ‡‚çš„jvmç²‰å¢¨ç™»åœºğŸ¤£

ä¸»è¦æ•´ç†è‡ªï¼šhttps://www.jyt0532.com

# ä¸‰å¤§æ¦‚å¿µ

specification è§„èŒƒ

implementation å®ç°

runtime instance è¿è¡Œå®ä¾‹ï¼Œæ¯ä¸€æ¬¡java hello å°±åˆ›å»ºäº†ä¸€ä¸ªjvmçš„è¿è¡Œå®ä¾‹

<img src="assets/image-20250506105607813.png" alt="image-20250506105607813" style="zoom:50%;" />







# class

elfæ–‡ä»¶æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒåŒç†classæ–‡ä»¶å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„

classæ–‡ä»¶çš„15ä¸ªéƒ¨åˆ†ï¼š

<img src="assets/image-20250506111404559.png" alt="image-20250506111404559" style="zoom:50%;" />

1.Magic Number é­”æ•¸

2.Version ç‰ˆæœ¬è™Ÿ

3.Constant Pool Count å¸¸é‡æ± æ•¸é‡ 2ä¸ªå­—èŠ‚ï¼Œ16ä½æ•…å¸¸é‡æœ€å¤š2^16^ =65,536 ä¸ª

4.Constant Pool å¸¸é‡æ± 

5.Access Flags è¨ªå•æ¨™èªŒ

6.Class Name é¡åˆ¥åç¨±

7.Super Class Name çˆ¶é¡åˆ¥åç¨±

8.Interfaces Count æ¥å£çš„æ•¸é‡ = 0001:1ä¸ªæ¥å£

9.Interfaces æ¥å£ = 0005:å¸¸é‡æ± ç¬¬5ä¸ªç´¢å¼•

10.Fields Count å­—æ®µçš„æ•¸é‡ = 0001:1ä¸ªå­—æ®µ

11.Fields å­—æ®µ 

12.Methods Count æ–¹æ³•çš„æ•¸é‡

13.Methods æ–¹æ³•

æ–¹æ³•ä¸å­—æ®µçš„ç»“æ„ï¼š

<img src="assets/image-20250506114303426.png" alt="image-20250506114303426" style="zoom:50%;" />

å…¶ä¸­descriptor_indexæè¿°äº†å‚æ•°ç±»å‹ä¸è¿”å›ç±»å‹

14.Attributes Count å±¬æ€§çš„æ•¸é‡

15.Attributes å±¬æ€§



ç»ˆææ€å™¨ï¼šjavap -verbose a.class

https://www.jyt0532.com/2020/03/01/class-file-structure/



```java
public class demo {

    int a = 1;

    static int b = 2;

    static final int c = 3;

    final int d = 4;

    String e = "ee";

    public static void main(String[] args) {
        System.out.println(b);
    }
}
```

```shell
liaozk@mac-air jvm % javap -verbose demo
Classfile /Users/liaozk/Documents/Foundation/jvm/out/production/jvm/demo.class
  Last modified 2025å¹´5æœˆ6æ—¥; size 739 bytes
  SHA-256 checksum 401ff86cf6fc738b07c81d15def8b323ae0c425787457ea2d5637a84319ae113
  Compiled from "demo.java"
public class demo
  minor version: 0
  major version: 61
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #8                          // demo
  super_class: #2                         // java/lang/Object
  interfaces: 0, fields: 5, methods: 3, attributes: 1
Constant pool:
   #1 = Methodref          #2.#3          // java/lang/Object."<init>":()V
   #2 = Class              #4             // java/lang/Object
   #3 = NameAndType        #5:#6          // "<init>":()V
   #4 = Utf8               java/lang/Object
   #5 = Utf8               <init>
   #6 = Utf8               ()V
   #7 = Fieldref           #8.#9          // demo.a:I
   #8 = Class              #10            // demo
   #9 = NameAndType        #11:#12        // a:I
  #10 = Utf8               demo
  #11 = Utf8               a
  #12 = Utf8               I
  #13 = Fieldref           #8.#14         // demo.d:I
  #14 = NameAndType        #15:#12        // d:I
  #15 = Utf8               d
  #16 = String             #17            // ee
  #17 = Utf8               ee
  #18 = Fieldref           #8.#19         // demo.e:Ljava/lang/String;
  #19 = NameAndType        #20:#21        // e:Ljava/lang/String;
  #20 = Utf8               e
  #21 = Utf8               Ljava/lang/String;
  #22 = Fieldref           #23.#24        // java/lang/System.out:Ljava/io/PrintStream;
  #23 = Class              #25            // java/lang/System
  #24 = NameAndType        #26:#27        // out:Ljava/io/PrintStream;
  #25 = Utf8               java/lang/System
  #26 = Utf8               out
  #27 = Utf8               Ljava/io/PrintStream;
  #28 = Fieldref           #8.#29         // demo.b:I
  #29 = NameAndType        #30:#12        // b:I
  #30 = Utf8               b
  #31 = Methodref          #32.#33        // java/io/PrintStream.println:(I)V
  #32 = Class              #34            // java/io/PrintStream
  #33 = NameAndType        #35:#36        // println:(I)V
  #34 = Utf8               java/io/PrintStream
  #35 = Utf8               println
  #36 = Utf8               (I)V
  #37 = Utf8               c
  #38 = Utf8               ConstantValue
  #39 = Integer            3
  #40 = Integer            4
  #41 = Utf8               Code
  #42 = Utf8               LineNumberTable
  #43 = Utf8               LocalVariableTable
  #44 = Utf8               this
  #45 = Utf8               Ldemo;
  #46 = Utf8               main
  #47 = Utf8               ([Ljava/lang/String;)V
  #48 = Utf8               args
  #49 = Utf8               [Ljava/lang/String;
  #50 = Utf8               <clinit>
  #51 = Utf8               SourceFile
  #52 = Utf8               demo.java
{
  int a;
    descriptor: I
    flags: (0x0000)

  static int b;
    descriptor: I
    flags: (0x0008) ACC_STATIC

  static final int c;
    descriptor: I
    flags: (0x0018) ACC_STATIC, ACC_FINAL
    ConstantValue: int 3

  final int d;
    descriptor: I
    flags: (0x0010) ACC_FINAL
    ConstantValue: int 4

  java.lang.String e;
    descriptor: Ljava/lang/String;
    flags: (0x0000)

  public demo();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: aload_0
         5: iconst_1
         6: putfield      #7                  // Field a:I
         9: aload_0
        10: iconst_4
        11: putfield      #13                 // Field d:I
        14: aload_0
        15: ldc           #16                 // String ee
        17: putfield      #18                 // Field e:Ljava/lang/String;
        20: return
      LineNumberTable:
        line 1: 0
        line 3: 4
        line 9: 9
        line 11: 14
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      21     0  this   Ldemo;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #22                 // Field java/lang/System.out:Ljava/io/PrintStream;
         3: getstatic     #28                 // Field b:I
         6: invokevirtual #31                 // Method java/io/PrintStream.println:(I)V
         9: return
      LineNumberTable:
        line 14: 0
        line 15: 9
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      10     0  args   [Ljava/lang/String;

  static {};
    descriptor: ()V
    flags: (0x0008) ACC_STATIC
    Code:
      stack=1, locals=0, args_size=0
         0: iconst_2
         1: putstatic     #28                 // Field b:I
         4: return
      LineNumberTable:
        line 5: 0
}
SourceFile: "demo.java"
liaozk@mac-air jvm % 
```









# Class Loader

è¾“å…¥=ç±»æ–‡ä»¶ï¼ˆå¦‚Hello.classï¼‰

è¾“å‡º=æœ‰ä¸¤ä¸ªï¼š

1. ç±»å¯¹è±¡ï¼ˆ`Class<Hello>`å¯¹è±¡ï¼‰å­˜åœ¨å †é‡Œï¼ˆåå°„çš„å…¥å£+å®ä¾‹åŒ–çš„æ¨¡æ¿ï¼‰
2. ç±»çš„å„ç§ä¿¡æ¯å¦‚å­—æ®µã€æ–¹æ³•ç­‰å­˜åœ¨æ–¹æ³•åŒº



è¿‡ç¨‹ï¼š

1. åŠ è½½é˜¶æ®µï¼šè¯»å–.classæ–‡ä»¶å¹¶è½¬æ¢ä¸ºå­—èŠ‚ç æ•°æ®
2. å†…å­˜æ˜ å°„ï¼š
   1. heap åˆ›å»ºClasså¯¹è±¡ä½œä¸ºè¿è¡Œæ—¶è®¿é—®ç±»çš„å…¥å£
   2. æ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰å­˜å‚¨ç±»ç»“æ„ä¿¡æ¯ï¼Œä¾›jvmæ‰§è¡Œæ–¹æ³•è§£æå­—æ®µ
3. åˆå§‹åŒ–ï¼šé™æ€å˜é‡èµ‹å€¼ï¼Œé™æ€ä»£ç å—





## ç±»åŠ è½½çš„æ—¶æœº

åŠ¨æ€åŠ è½½ï¼Œå¹¶ä¸æ˜¯ä¸€å¼€å§‹å°†æ‰€æœ‰ç±»éƒ½åŠ è½½ï¼Œè€Œæ˜¯ç”¨åˆ°æ—¶å†åŠ è½½ã€‚

ä¸»åŠ¨ä½¿ç”¨ï¼šå®Œæ•´çš„åŠ è½½æµç¨‹

è¢«åŠ¨ä½¿ç”¨ï¼šä¼šè¢«åŠ è½½ï¼Œä½†ä¸ä¼šè¢«åˆå§‹åŒ–



ä¸»åŠ¨ä½¿ç”¨-ç±»ï¼š

1.ç”¨äº†new é—œéµå­— ä»£è¡¨æ–°ç‰©ä»¶è¢«å‰µå»º

2.static methodè¢«å‘¼å«

3.static variableè¢«å­˜å–(**ä½†compile-time å¸¸æ•¸ä¾‹å¤–**)

4.å¦‚æœæ­¤é¡åˆ¥çš„å­é¡è¢«åˆå§‹åŒ–æ™‚ æ­¤é¡åˆ¥é‚„æ²’è¢«åˆå§‹åŒ– å‰‡æœƒå…ˆåˆå§‹åŒ–æ­¤é¡åˆ¥

5.å¾å‘½ä»¤åˆ—è¢«åŸ·è¡Œæ™‚ ç”¨æˆ¶æŒ‡å®šçš„ä¸»é¡(å°±æ˜¯public static void main(String[] args) æ‰€åœ¨çš„é¡)

6.ä»»ä½•çš„åå°„èª¿ç”¨

ä¸»åŠ¨ä½¿ç”¨-æ¥å£ï¼š

1.static methodè¢«å‘¼å«

2.static variableè¢«å­˜å–(ä½†compile-time å¸¸æ•¸ä¾‹å¤–)

3.å¾å‘½ä»¤åˆ—è¢«åŸ·è¡Œæ™‚ ç”¨æˆ¶æŒ‡å®šçš„ä¸»é¡(å°±æ˜¯public static void main() æ‰€åœ¨çš„é¡)

4.ä»»ä½•çš„åå°„èª¿ç”¨



æ¥å£ä¸ç±»ç›¸æ¯”ï¼ŒåŒºåˆ«åœ¨äºï¼š

**1.æ¥å£æ²¡æœ‰new**

**2.å­ç±»è¢«åˆå§‹åŒ–æ—¶ï¼Œçˆ¶ç±»ä¹Ÿä¼šè¢«åŠ è½½ï¼Œæ¥å£åˆ™ä¸ä¸€å®šï¼Œæ¥å£å­ç±»è¢«åˆå§‹åŒ–æ—¶å¹¶ä¸å¼ºåˆ¶è¦æ±‚åˆå§‹åŒ–æ¥å£çˆ¶ç±»**





## ç±»åŠ è½½

æ›´è¯¦ç»†çš„åŠ è½½å‘¨æœŸï¼š

åŠ è½½ï¼šå»ç±»è·¯å¾„ä¸‹é¢æ‰¾åˆ°æ–‡ä»¶çš„byteæµï¼Œè½½å…¥åç”Ÿæˆinstance of java.lang.Class

éªŒè¯ï¼š

å‡†å¤‡ï¼šä¸ºstatic variable åˆ†é…å†…å­˜ï¼Œå¹¶ç»™äºˆé¢„è®¾å€¼ï¼ˆintç±»å‹é»˜è®¤ä¸º0ï¼‰ï¼Œstatic final åˆ™èµ‹äºˆç»™å®šçš„å…·ä½“å€¼

è§£æï¼šå±äºjavaçš„è¿æ¥ï¼Œå°†classä¸­çš„å…¨é™å®šåç§°å¼•ç”¨è½¬å˜ä¸ºå†…å­˜åœ°å€/åç§»é‡

åˆå§‹åŒ–ï¼šå°†static éfinalçš„å˜é‡åˆå§‹åŒ–ä¸ºå„è‡ªå¯¹åº”çš„çœŸæ­£åˆå§‹å€¼



éªŒè¯å‡†å¤‡è§£æï¼šåˆå¯ç»Ÿç§°ä¸ºé“¾æ¥

è§£æä¹Ÿå¯ä»¥æ”¾åœ¨åˆå§‹åŒ–ä¹‹å





### åŠ è½½

åœ¨é€™å€‹éšæ®µ æœ‰ä¸‰ä»¶äº‹æƒ…å¿…é ˆè¦å®Œæˆ

1.ç”¨å…¶ä¸­ä¸€å€‹åŠ è¼‰å™¨ é€éä¸€å€‹é¡åˆ¥çš„å®Œå…¨é™å®šåæ‰¾åˆ°.classæª”æ¡ˆ(å­—ç¯€æµ)

2.å°‡é€™å€‹å­—ç¯€æµä¸­çš„é¡åˆ¥è³‡è¨Šå­˜é€²æ–¹æ³•å€

3.åœ¨Heapä¸­ ç”Ÿæˆä¸€å€‹é€™å€‹é¡åˆ¥çš„é¡ç‰©ä»¶



<img src="assets/image-20250506160351868.png" alt="image-20250506160351868" style="zoom:50%;" />

1.é¡åŠ è¼‰å™¨å…ˆå»çœ‹é€™å€‹é¡ç‰©ä»¶æ˜¯ä¸æ˜¯å·²ç¶“åœ¨heapè£¡äº†

2.å¦‚æœå·²ç¶“åœ¨heapè£¡äº† å°±å¾heapå›å‚³class object

3.æ²’æœ‰åœ¨heapçš„è©± ä»£è¡¨é€™å€‹typeç¬¬ä¸€æ¬¡è¢«å­˜å– é‚£é¡åŠ è¼‰å™¨å°±æœƒå»å°‹æ‰¾é€™å€‹class

4.å¦‚æœæ‰¾ä¸åˆ° å°±æ‹‹å‡ºClassNotFoundException

5.æ‰¾åˆ°çš„è©± å°±ç”Ÿæˆé¡ç‰©ä»¶ ä¸¦ä¸”å­˜é€²heap



#### åŠ è½½å™¨

<img src="assets/image-20250506160546375.png" alt="image-20250506160546375" style="zoom:30%;" />



å¯åŠ¨ç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½$JAVA_HOME/libä¸‹èƒ½è¢«jvmè¯†åˆ«çš„ç±»åº“ï¼Œæ— æ³•è¢«javaç¨‹åºå¼•ç”¨

æ‰©å±•ç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½$JAVA_HOME/lib/ext/*.jaråŠç³»ç»Ÿå˜é‡java.ext.dirs æŒ‡å®šçš„ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œjavaç¨‹åºå¯ä»¥ç›´æ¥ç”¨æ‰©å±•ç±»åŠ è½½å™¨

åº”ç”¨ç¨‹åºåŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½ç”¨æˆ·è·¯å¾„ä¸­çš„æ–‡ä»¶



### Parent Delegation Model

åŒäº²å§”æ´¾æ¨¡å‹ï¼Œæ›´åº”è¯¥å«çˆ¶äº²å§”æ´¾æ¨¡å‹ï¼šæ”¶åˆ°åŠ è½½è¯·æ±‚æ—¶å§”æ´¾ç»™çˆ¶ç±»ï¼Œçˆ¶ç±»æ— æ³•åŠ è½½æ‰ä¼šè‡ªå·±å»å°è¯•åŠ è½½

å­åŠ è½½å™¨æ”¶åˆ°åŠ è½½`java.lang.String`çš„è¯·æ±‚æ—¶ï¼Œä¼šé€çº§å§”æ´¾è‡³Bootstrap ClassLoaderï¼ˆæ ¸å¿ƒç±»ç”±å…¶åŠ è½½

æ³¨æ„ï¼Œè¿™é‡Œä¸æ˜¯ä¸€ç§ç»§æ‰¿å…³ç³»ï¼











### Class Object

ç±»ç‰©ä»¶ï¼Œclasså¯¹è±¡ï¼Œæ‰€æœ‰çš„typeéƒ½æœ‰

Class

Interface

Primitives(byte, short, int, long, float, double, boolean, char)

Void

Arrays





## éªŒè¯

ç•¥



## Preparation

åˆ†é…ç©ºé—´&é»˜è®¤å€¼

| Data Type              | Default Value (for fields) |
| ---------------------- | -------------------------- |
| byte                   | 0                          |
| short                  | 0                          |
| int                    | 0                          |
| long                   | 0L                         |
| float                  | 0.0f                       |
| double                 | 0.0d                       |
| char                   | â€˜u0000â€™                    |
| String (or any object) | null                       |
| boolean                | FALSE                      |





## Resolution

æƒ³èµ·äº†cè¯­è¨€çš„GTO ä¸PTL äº†

oop-klassæ¨¡å‹



## Initialization



æ‰§è¡Œé™æ€ä»£ç å—



## ç±»åŠ è½½é¡ºåº

1. æ‰€æœ‰çš„é™æ€åˆå§‹å—ä¼šè¢«åˆå¹¶ï¼ŒåŒ…æ‹¬é™æ€å˜é‡çš„å£°æ˜
2. æ‰€æœ‰çš„å®ä¾‹åˆå§‹åŒ–ä¹Ÿä¼šè¢«åˆå¹¶
3. å®ä¾‹åˆå§‹åŒ–ä¼˜å…ˆäºæ„é€ å™¨



Jvm æ–°å¢é€‰é¡¹ `-verbose:class`









# åå°„

ä½¿ç”¨åå°„çš„å¤§å‰ææ˜¯Classå¯¹è±¡å·²ç»è¢«åˆ›å»ºå†heapä¸­äº†

å¤§å‰ææˆç«‹çš„æƒ…æ³ä¸‹ æœ‰å››ç¨®æ–¹æ³•å¯ä»¥ä½¿ç”¨å¾—åˆ°é¡ç‰©ä»¶

todoï¼štypeæ˜¯ä»€ä¹ˆï¼Ÿ



è¯¦ç»†ä½¿ç”¨ç•¥



# Execution Engine

ç±»åŠ è½½å®Œåï¼Œå­—èŠ‚ç å­˜æ”¾åœ¨æ–¹æ³•åŒºï¼Œç„¶åç”±æ‰§è¡Œå¼•æ“ä¸€ä¸ªæŒ‡ä»¤ä¸€ä¸ªæŒ‡ä»¤å»æ‰§è¡Œ



è§£é‡Šæ‰§è¡Œ+JITï¼ˆJust-in-time compilerï¼‰

åŸºæœ¬ä»£ç éƒ½æ˜¯åœ¨interpreterä¸­æ‰§è¡Œï¼Œéƒ¨åˆ†ç»å¸¸è°ƒç”¨çš„ä¼šé€šè¿‡JITç¼–è¯‘æˆæœºå™¨ç 

<img src="assets/image-20250506180530985.png" alt="image-20250506180530985" style="zoom:50%;" />





# Runtime Data Areas

å¤§å¤´ï¼Œé‡è¦çš„éƒ¨åˆ†ï¼ŒçŠ¶æ€æœºçš„çŠ¶æ€ã€‚



<img src="assets/image-20250507141655435.png" alt="image-20250507141655435" style="zoom:50%;" />



1.jvmä¸­ä½¿ç”¨ æ“ä½œæ•°stack è¿›è¡Œä¼ å‚ï¼Œç±»ä¼¼æ±‡ç¼–ä¸­çš„å¯„å­˜å™¨

2.æ¯ä¸ªæ ˆå¸§éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¿™ä¸ªæ ˆå¸§æ‰€å±æ–¹æ³•çš„æŒ‡é’ˆ

3.æœ¬åœ°æ–¹æ³•æœ‰ç‹¬ç«‹çš„stack



## æ–¹æ³•åŒº

æ–¹æ³•åŒºæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå‰é¢æåˆ°åŠ è½½å™¨è¾“å…¥byte arrayï¼Œè¾“å‡ºClass< T > åˆ°heap + å­—æ®µæ–¹æ³•ç­‰åˆ°æ–¹æ³•åŒº

æ–¹æ³•åŒºä¸­ï¼Œæ¯ä¸ªç±»æœ‰8ç§matedata

<img src="assets/image-20250507143637756.png" alt="image-20250507143637756" style="zoom:50%;" />



1.Runtime Constant Pool 

è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ¯ä¸ªç±»æœ‰å„è‡ªçš„ï¼ŒåŒºåˆ«äºå­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆheapä¸­ï¼Œæ‰€æœ‰ç±»å…±äº«jvmåªæœ‰ä¸€ä¸ªï¼‰ã€‚

classæ–‡ä»¶ä¸­çš„å¸¸é‡æ± +otherä¿¡æ¯



2.Type Information

ç±»çš„ï¼šå…¨é™å®šåç§°+æ¥å£/ç±»+çˆ¶ç±»/çˆ¶æ¥å£çš„å…¨é™å®šåç§°+è®¿é—®ä¿®é¥°ï¼ˆpublicï¼Œprivateï¼Œabstractï¼‰



3.Field Information

å°æ–¼ä¸€å€‹é¡åˆ¥çš„æ‰€æœ‰å­—æ®µ éƒ½å¿…é ˆå­˜åœ¨æ–¹æ³•å€

1.å­—æ®µåç¨±

2.å­—æ®µé¡åˆ¥

3.å­—æ®µä¿®é£¾ç¬¦(public, private, static, final, transient, volatile)



æ³¨æ„ï¼šç±»staticçš„å˜é‡å­˜åœ¨äºæ–¹æ³•åŒºClass variableï¼ˆä¸‹å›¾çš„f2 ä¸ eï¼‰



æ‰€ä»¥ åˆ—å‡ºæ‰€æœ‰æ’åˆ—çµ„åˆçµ¦ä½ 

|                             | åŸå§‹é¡å‹(primitive type) | å¼•ç”¨é¡å‹(reference) |
| --------------------------- | ------------------------ | ------------------- |
| éœæ…‹è®Šé‡(static variable)   | å€¼:æ–¹æ³•å€                | å¼•ç”¨: æ–¹æ³•å€ å€¼: å † |
| å¯¦ä¾‹è®Šé‡(instance variable) | å€¼:å †                    | å¼•ç”¨: å † å€¼: å †     |
| å±€éƒ¨è®Šé‡(local variable)    | å€¼:æ£§                    | å¼•ç”¨: æ£§ å€¼: å †     |

ä¸Šç¯„ä¾‹ç¨‹å¼

```
public class Demo {
 public static void main(String args[]){
   int a = 1;
   Integer b = 2;
   Hello c = new Hello();
 }
}
public class Hello {
 int d  = 3;
 static int e = 4;
 Foo f1 = new Foo();
 static Foo f2 =  new Foo();
}
public class Foo {
}
```



<img src="assets/image-20250507144616385.png" alt="image-20250507144616385" style="zoom:50%;" />



4.Method Information

æ–¹æ³•ï¼šåç§°+è¿”å›ç±»å‹+å‚æ•°+ä¿®é¥°ç¬¦+...



5.Class variable

é final çš„ static å˜é‡

finalçš„static å­˜åœ¨ä¸å¸¸é‡æ± 



6.Method table

ç®€å•ç†è§£ä¸ºä¿å­˜äº†å®ä¾‹æ–¹æ³•çš„å­—èŠ‚ç ï¼Œæä¾›ä¸€ä¸ªentry



7.Reference to ClassLoader table

æ˜¯é‚£ä¸ªåŠ è½½å™¨åŠ è½½çš„ç±»



8.Reference to Class object

æŒ‡å‘å¯¹åº”çš„Classå¯¹è±¡





## å †

å­˜æ”¾äº†æ‰€æœ‰å®ä¾‹å¯¹è±¡ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«



å †é‡Œæœ‰ä¸€ä¸ªå…¨å±€å…±äº«çš„å­—ç¬¦ä¸²å¸¸é‡æ± ï¼š

åŠå…¶ç¹ççš„ç»†èŠ‚å°±ä¸æ¢ç©¶äº†

æ³¨æ„ä¸‹é¢ï¼š

```java
String s = "abc";
//å¯ä»¥ç®€å•ç­‰ä»·ä¸ºä¸‹é¢,åŒºåˆ«ï¼šé™¤äº†åœ¨å¸¸é‡æ± ä¸­å¤šäº†abc è¿˜ä¼šå¤šä¸€ä¸ªnew String("abc)
String s = new String("abc").intern();
```









## æ€»ç»“

stackï¼šå¼•ç”¨+åŸºæœ¬ç±»å‹

heapï¼šå®ä¾‹+Class

æ–¹æ³•åŒºï¼šç±»çš„ç›¸å…³ä¿¡æ¯



<img src="assets/image-20250507151551954.png" alt="image-20250507151551954" style="zoom:50%;" />



````java
Hello hello1 = new Hello();
Hello hello2 = new Hello();
World world = new World();
````







# Garbage Collector

æ¯ä¸€ä¸ªjavaer ç¬¬ä¸€æ¬¡å¼€å§‹å†™cä»£ç æ—¶å°±ä¼šæ„Ÿå—åˆ°jvmä¸€ç›´ä»¥æ¥çš„é»˜é»˜ä»˜å‡ºã€‚

wwwwhï¼š

whereï¼šheap ï¼›æ–¹æ³•åŒºä¸­çš„ä¿¡æ¯ä¹Ÿæœ‰å¯èƒ½è¢«å›æ”¶ï¼Œä½†æ¡ä»¶éå¸¸ä¸¥æ ¼ã€‚

whyï¼šå¨æˆ¿çš„åƒåœ¾æ¡¶ï¼Œæ°¸è¿œéƒ½ä¸å¤Ÿå¤§

whatï¼šæ— æ³•è¢«å¼•ç”¨çš„å¯¹è±¡

whenï¼š

howï¼š





## Whatå¦‚ä½•æ‰¾åˆ°é‚£äº›æ— æ³•è¢«å¼•ç”¨çš„å¯¹è±¡

1.å¼•ç”¨è®¡æ•° - æ— æ³•è§£å†³å¾ªç¯å¼•ç”¨

2.å¯è¾¾æ€§åˆ†æï¼šä»gc rootå‡ºå‘ï¼Œæ— æ³•åˆ°è¾¾çš„å¯¹è±¡å°±åº”è¯¥è¢«å›æ”¶



### GCroot

ç•¥ï¼šä»å„ç±»å¼•ç”¨å‡ºå‘

é‚£ä»€éº¼æ˜¯GC Rootå‘¢ ä¸‹åˆ—çš„äººé¸éƒ½æ˜¯æˆ‘å€‘çš„GC Root

1.JVMæ£§æ¥¨è£¡çš„å±€éƒ¨è®Šé‡ æŒ‡åˆ°çš„å°è±¡: ç†æ‰€ç•¶ç„¶ æ£§æ¥¨é‚„åœ¨ é‚£å±€éƒ¨è®Šé‡æŒ‡åˆ°çš„éƒ½ä¸æ‡‰è©²è¢«å›æ”¶

2.æ–¹æ³•å€è£¡çš„staticè®Šæ•¸ æŒ‡åˆ°çš„å°è±¡: ç†æ‰€ç•¶ç„¶ é¡åˆ¥ç­‰ç´šçš„è®Šé‡ å³ä½¿æ²’æœ‰ä»»ä½•çš„å¯¦ä¾‹ åªè¦æ–¹æ³•å€çš„é¡åˆ¥æ²’æœ‰è¢«å›æ”¶ é‚£æ–¹æ³•å€ä¸­è·Ÿé€™å€‹é¡åˆ¥ç›¸é—œçš„éœæ…‹è®Šæ•¸éƒ½ä¸è©²è¢«æ¸…ç† å› ç‚ºé‚£äº›éœæ…‹è®Šæ•¸å·²ç¶“è¢«åŠ è¼‰äº† ä»£è¡¨éš¨æ™‚å¯èƒ½æœƒç”¨åˆ°

3.ç³»çµ±é¡åˆ¥(System Class): ä¹Ÿå°±æ˜¯è¢«å•Ÿå‹•é¡åŠ è¼‰å™¨åŠ è¼‰çš„é¡åˆ¥ æ¯”å¦‚èªª`rt.jar`(Runtime enviroment) æˆ–æ˜¯`java.util.*`ç­‰é¡åˆ¥

4.æœ¬åœ°æ–¹æ³•æ£§ä¸­çš„æœ¬åœ°æ–¹æ³•æ‰€å¼•ç”¨çš„å°è±¡: ä¹Ÿæ˜¯ç†æ‰€ç•¶ç„¶ äººå®¶æ£§è£¡é¢çš„æ±è¥¿éƒ½ä¸è©²æ¸…æ‰ åŒ…å«äº†æœ¬åœ°æ–¹æ³•çš„å±€éƒ¨è®Šæ•¸è·Ÿå…¨å±€è®Šé‡

5.ç·šç¨‹(Thread): æ‰€æœ‰æ­£åœ¨è·‘çš„ç·šç¨‹ä»¥åŠé€™äº›ç·šç¨‹æ‰€æŒ‡åˆ°çš„ç‰©ä»¶

6.åœ¨finalizer queueè£¡é¢ é‚„æ²’è·‘finalizeræ–¹æ³•çš„ç‰©ä»¶

è¢«é€™äº›æŒ‡åˆ°çš„ éƒ½æ˜¯èè‹±ä¸­å¿ƒè£¡é¢çš„äºº æ²’è¢«æŒ‡åˆ°çš„å°±æ˜¯åƒåœ¾



### å¼•ç”¨

å¼º

è½¯ï¼šå³å°†æº¢å‡ºæ—¶ï¼Œè¿™ç±»å¼•ç”¨ä¹Ÿä¼šè¢«æ¸…ç†æ‰

å¼±ï¼šä¸‹ä¸€æ¬¡gcä¼šè¢«æ¸…ç†

è™šï¼šè·Ÿæ²¡å¼•ç”¨ä¸€æ ·

Reference Queue





## how å›æ”¶

1.Mark-Sweepæ ‡è®°å¹¶æ¸…é™¤

<img src="assets/image-20250507164304708.png" alt="image-20250507164304708" style="zoom:33%;" />

ç¢ç‰‡å¤š

2.Mark-Compactæ ‡è®°å¹¶æ•´ç†

<img src="assets/image-20250507164953553.png" alt="image-20250507164953553" style="zoom:33%;" />

æ•´ç†è€—æ—¶ï¼Œé€‚åˆåƒåœ¾å°‘

3.Mark-Copy

<img src="assets/image-20250507165058672.png" alt="image-20250507165058672" style="zoom:33%;" />

éœ€è¦é¢å¤–ç©ºé—´ï¼Œé€‚åˆåƒåœ¾å¤š





æ‚ç³…ï¼š

<img src="assets/image-20250507165448259.png" alt="image-20250507165448259" style="zoom:33%;" />



å†ä¾†å°±å‰©ä¸‹ä¸€äº›ç´°ç¯€

1.æ–°å¤§å€åˆç¨±ç‚ºä¼Šç”¸åœ’å€(Eden) æ–°å°1ç¨±ç‚ºSurvivor1 æ–°å°2ç¨±ç‚ºSurvivor2

2.ä¼Šç”¸å€è·ŸSurvivorå€çš„æ¯”ä¾‹å¯ä»¥åœ¨è·‘ç¨‹å¼çš„æ™‚å€™è‡ªå·±çµ¦å®š `-Xx:SurvivorRatio`

3.åœ¨Survivorå€å­˜æ´»å¹¾æ¬¡æ‰é€²è€å¹´ä»£çš„æ¬¡æ•¸ä¹Ÿå¯ä»¥è‡ªå·±çµ¦å®š `-XX:MaxTenuringThreshold`

4.å¦‚æœæœ‰å€‹å°è±¡å¤ªå¤§æ ¹æœ¬ç„¡æ³•åœ¨ä¼Šç”¸å€åˆ†é…ç©ºé–“ é‚£å°±ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…

5.å¦‚æœæœ‰å°è±¡å¤ªå¤§ ç„¡æ³•åœ¨Minor GCä¹‹å¾Œæ”¾é€²Survivorå€ é‚£ä¹Ÿæ˜¯ç›´æ¥é€²è€å¹´ä»£



override äº† finalize ä¼šç»™å¯¹è±¡ä¸€æ¬¡ç¼“è¡Œï¼Œç¬¬ä¸€æ¬¡GCæ—¶ï¼Œå‘ç°æœ‰finalize ä¸”æœªè¢«æ‰§è¡Œï¼Œä¼šç¼“è¡Œï¼Œä¸‹æ¬¡GCå†å›é¦–ã€‚



å…ƒç©ºé—´ï¼ˆæ–¹æ³•åŒºï¼‰çš„å›æ”¶ï¼Œç•¥è¿‡ã€‚















# å†…å­˜ä¸­çš„ä¸€ä¸ªå¯¹è±¡

javaåœ¨heapä¸­çš„æ¯ä¸ªå®ä¾‹ï¼Œé™¤äº†è‡ªèº«çš„å®ä¾‹æ•°æ®ä¸å¯¹å…¶å¡«å……å¤–ï¼Œé¢å¤–æœ‰ä¸€ä¸ªå¯¹è±¡å¤´ã€‚

Object Headerï¼š

Mark Wordâ€Œï¼šæ ‡è®°å­—æ®µï¼Œè®°å½•äº†é”æ ‡å¿—ä½ï¼ŒGCåˆ†ä»£ï¼Œhashç­‰ï¼Œä¸€èˆ¬8å­—èŠ‚

â€ŒKlass Pointerï¼šæŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•åŒºç±»çš„å…ƒæ•°æ®



æ•°ç»„å¯¹è±¡å¤šäº†é•¿åº¦ä¿¡æ¯ï¼š4å­—èŠ‚

<img src="assets/image-20250507174603208.png" alt="image-20250507174603208" style="zoom:50%;" />







ä¸å¼€å¯å‹ç¼©æŒ‡é’ˆ

```java
class A{
  int a = 1;//4å­—èŠ‚
  boolean b = false;//1å­—èŠ‚
  classC c ;//æŒ‡é’ˆ8å­—èŠ‚
}
```

å¯¹è±¡å¤´ï¼š8+8 = 16å­—èŠ‚

å¯¹è±¡å®ä¾‹ï¼š4+1+8 = 13å­—èŠ‚

å¯¹é½ï¼š32-29 = 3å­—èŠ‚

æ€»è®¡å ç”¨å†…å­˜ï¼š32å­—èŠ‚ã€‚



```java
//jolå¯ä»¥æŸ¥çœ‹å¯¹è±¡å¸ƒå±€
public static void main(String[] args) {
    User user=new User();
    //æŸ¥çœ‹å¯¹è±¡çš„å†…å­˜å¸ƒå±€
    System.out.println(ClassLayout.parseInstance(user).toPrintable());
}
```



å¯¹è±¡å¤´çš„5ç§çŠ¶æ€ï¼šä¸€å…±æœ‰64ä¸ªbit

<img src="assets/image-20250507174759491.png" alt="image-20250507174759491" style="zoom:50%;" />



æ›´å¤šçš„å…³äºé”ä¸å¯¹è±¡ï¼Œæ­¤å¤„æš‚ç•¥ã€‚

















